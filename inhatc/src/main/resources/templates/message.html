<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë©”ì‹œì§€</title>
    <link rel="stylesheet" href="/css/sidebar.css" />
    <script th:src="@{/webjars/sockjs-client/sockjs.min.js}"></script>
    <script th:src="@{/webjars/stomp-websocket/stomp.min.js}"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background-color: #ffffff;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        color: #0f1419;
        line-height: 1.5;
        min-height: 100vh;
        padding: 0;
        margin: 0;
      }

      .wrapper {
        display: flex;
        max-width: 1200px;
        margin: 0 auto;
        background-color: #ffffff;
        min-height: 100vh;
      }

      .chat-header {
        position: sticky;
        top: 0;
        background-color: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(12px);
        border-bottom: 1px solid #eff3f4;
        padding: 16px 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        flex-shrink: 0;
        z-index: 100;
        min-height: 64px;
      }

      .chat-header h2 {
        font-size: 20px;
        font-weight: 700;
        color: #0f1419;
        margin: 0;
      }

      .back-button {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.2s;
        border: none;
        background: transparent;
        font-size: 20px;
        color: #0f1419;
      }

      .back-button:hover {
        background-color: #f7f9f9;
      }

      /* ëª©ë¡ ëª¨ë“œ ì»¨í…Œì´ë„ˆ */
      #listMode {
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: 0;
        overflow: hidden;
        height: calc(100vh - 0px);
      }

      /* ëŒ€í™” ìƒëŒ€ ëª©ë¡ ìŠ¤íƒ€ì¼ */
      .conversation-list {
        flex: 1;
        overflow-y: auto;
        background-color: #ffffff;
        min-height: 0;
        max-height: 100%;
      }

      .conversation-item {
        padding: 16px;
        border-bottom: 1px solid #eff3f4;
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        gap: 12px;
        align-items: center;
      }

      .conversation-item:hover {
        background-color: #f7f9f9;
      }

      .conversation-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background-color: #1d9bf0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ffffff;
        font-weight: 700;
        font-size: 18px;
        flex-shrink: 0;
      }

      .conversation-content {
        flex: 1;
        min-width: 0;
      }

      .conversation-name {
        font-size: 15px;
        font-weight: 700;
        color: #0f1419;
        margin-bottom: 4px;
      }

      .conversation-preview {
        font-size: 15px;
        color: #536471;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .conversation-time {
        font-size: 13px;
        color: #536471;
        margin-left: auto;
        flex-shrink: 0;
      }

      .empty-conversations {
        text-align: center;
        padding: 60px 20px;
        color: #536471;
        font-size: 15px;
      }

      /* ì±„íŒ… ëª¨ë“œ ì»¨í…Œì´ë„ˆ */
      #chatMode {
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: 0;
        overflow: hidden;
        height: calc(100vh - 0px);
      }

      .chat-messages {
        flex: 1;
        padding: 16px;
        overflow-y: auto;
        overflow-x: hidden;
        background-color: #ffffff;
        display: flex;
        flex-direction: column;
        gap: 12px;
        min-height: 0; /* flex ì»¨í…Œì´ë„ˆì—ì„œ ìŠ¤í¬ë¡¤ì´ ì‘ë™í•˜ë„ë¡ */
        max-height: 100%; /* ë¶€ëª¨ ì»¨í…Œì´ë„ˆì˜ ë†’ì´ë¥¼ ë„˜ì§€ ì•Šë„ë¡ */
      }

      /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ ê°œì„  (WebKit ë¸Œë¼ìš°ì €) */
      .chat-messages::-webkit-scrollbar {
        width: 8px;
      }

      .chat-messages::-webkit-scrollbar-track {
        background: #f7f9f9;
        border-radius: 4px;
      }

      .chat-messages::-webkit-scrollbar-thumb {
        background: #536471;
        border-radius: 4px;
      }

      .chat-messages::-webkit-scrollbar-thumb:hover {
        background: #0f1419;
      }

      /* Firefox ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
      .chat-messages {
        scrollbar-width: thin;
        scrollbar-color: #536471 #f7f9f9;
      }

      .message {
        display: flex;
        flex-direction: column;
        max-width: 75%;
        word-wrap: break-word;
      }

      .message.sent {
        align-self: flex-end;
        align-items: flex-end;
      }

      .message.received {
        align-self: flex-start;
        align-items: flex-start;
      }

      .message-content {
        padding: 12px 16px;
        border-radius: 20px;
        font-size: 15px;
        line-height: 1.4;
      }

      .message.sent .message-content {
        background-color: #1d9bf0;
        color: #ffffff;
        border-bottom-right-radius: 4px;
      }

      .message.received .message-content {
        background-color: #f7f9f9;
        color: #0f1419;
        border-bottom-left-radius: 4px;
      }

      .message-time {
        font-size: 12px;
        color: #536471;
        margin-top: 4px;
        padding: 0 4px;
      }

      .chat-input-container {
        padding: 12px 16px;
        border-top: 1px solid #eff3f4;
        background-color: #ffffff;
        display: flex;
        gap: 8px;
        align-items: center;
        flex-shrink: 0; /* ë†’ì´ê°€ ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ */
      }

      #messageInput {
        flex: 1;
        padding: 12px;
        border: 1px solid #eff3f4;
        border-radius: 24px;
        font-size: 15px;
        outline: none;
        font-family: inherit;
        resize: none;
        min-height: 44px;
        max-height: 120px;
      }

      #messageInput:focus {
        border-color: #1d9bf0;
      }

      #sendButton {
        padding: 10px 20px;
        background-color: #1d9bf0;
        color: #ffffff;
        border: none;
        border-radius: 24px;
        font-size: 15px;
        font-weight: 700;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      #sendButton:hover {
        background-color: #1a8cd8;
      }

      #sendButton:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* ì´ë¯¸ì§€ ì—…ë¡œë“œ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
      .image-upload-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .image-upload-button {
        padding: 8px 12px;
        background-color: #f7f9f9;
        color: #0f1419;
        border: 1px solid #eff3f4;
        border-radius: 20px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .image-upload-button:hover {
        background-color: #eff3f4;
      }

      .image-preview-container {
        position: relative;
        display: inline-block;
        margin-top: 8px;
      }

      .image-preview {
        max-width: 200px;
        max-height: 200px;
        border-radius: 12px;
        border: 1px solid #eff3f4;
      }

      .image-preview-remove {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 24px;
        height: 24px;
        background-color: #0f1419;
        color: #ffffff;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
      }

      .image-preview-remove:hover {
        background-color: #536471;
      }

      .message-image {
        max-width: 300px;
        max-height: 300px;
        border-radius: 12px;
        margin-top: 8px;
        cursor: pointer;
      }

      .message-image:hover {
        opacity: 0.9;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #536471;
        font-size: 15px;
      }

      /* ë°˜ì‘í˜• ë””ìì¸ */
      @media (max-width: 768px) {
        .wrapper {
          max-width: 100%;
          border-left: none;
          border-right: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <!-- ì™¼ìª½ ì‚¬ì´ë“œë°” -->
      <div class="sidebar">
        <a href="/main" class="sidebar-item">
          <img src="/images/home.png" alt="home" />
          <span>Home</span>
        </a>
        <a href="/member/mypage" class="sidebar-item">
          <img src="/images/user.png" alt="User" />
          <span>User</span>
        </a>
        <a href="/chat/message" class="sidebar-item active">
          <img src="/Message.png" alt="Message" />
          <span>Message</span>
        </a>
        <div class="sidebar-item" onclick="location.href='/posts/notifications/page';" style="cursor: pointer;">
          <img src="/images/alram.png" alt="Alarm" />
          <span>Alarm</span>
        </div>
        <div class="sidebar-item" onclick="document.getElementById('logout').submit();" style="cursor: pointer;">
          <img src="/images/logout.png" alt="Logout" />
          <span>Logout</span>
        </div>
        <form id="logout" action="/api/members/logout" method="post"></form>
      </div>

      <!-- ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ -->
      <div class="main-content">

      <!-- ëª©ë¡ ëª¨ë“œ -->
      <div id="listMode" th:if="${isChatMode == null or isChatMode == false}">
        <div class="chat-header">
          <h2>ë©”ì‹œì§€</h2>
        </div>
        <!-- ëª©ë¡ ëª¨ë“œìš© ë””ë²„ê¹… ë°ì´í„° -->
        <div id="listModeData" 
             th:data-sender-email="${senderEmail}"
             style="display: none;"></div>
        <div class="conversation-list" id="conversationList">
          <div class="loading">ëŒ€í™” ìƒëŒ€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
      </div>

      <!-- ì±„íŒ… ëª¨ë“œ -->
      <div id="chatMode" th:if="${isChatMode != null and isChatMode == true}">
        <div class="chat-header">
          <button class="back-button" onclick="goToListMode()" title="ëª©ë¡ìœ¼ë¡œ">â†</button>
          <h2 id="receiverName" th:text="${receiverName != null ? receiverName : receiverEmail}">ë©”ì‹œì§€</h2>
          <!-- ë””ë²„ê¹…ìš©: Thymeleaf ë³€ìˆ˜ë¥¼ data ì†ì„±ìœ¼ë¡œ ì „ë‹¬ -->
          <div id="debugData" 
               th:data-sender-email="${senderEmail}" 
               th:data-receiver-email="${receiverEmail}"
               style="display: none;"></div>
        </div>

        <div class="chat-messages" id="chatMessages">
          <div class="loading">ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>

        <div class="chat-input-container">
          <div class="image-upload-container" style="width: 100%;">
            <div style="display: flex; gap: 8px; align-items: center; width: 100%;">
              <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
              <button class="image-upload-button" onclick="document.getElementById('imageInput').click()">
                 ì´ë¯¸ì§€ ì—…ë¡œë“œ
              </button>
              <textarea
                id="messageInput"
                placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                rows="1"
                style="flex: 1;"
              ></textarea>
              <button id="sendButton" onclick="sendMessage()">ì „ì†¡</button>
            </div>
            <div id="imagePreviewContainer" style="display: none;"></div>
          </div>
        </div>
      </div>
      </div>
    </div>

    <script th:inline="javascript">
      let stompClient = null;
      const senderEmail = /*[[${senderEmail}]]*/ '';
      const receiverEmail = /*[[${receiverEmail}]]*/ '';
      const isChatMode = /*[[${isChatMode}]]*/ false;
      let roomName = '';

      // ë””ë²„ê¹… ì •ë³´ ì¶œë ¥
      // console.log("========================================");
      // console.log("[DEBUG] message.html ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œë¨");
      // console.log("  - senderEmail (Thymeleaf):", senderEmail);
      // console.log("  - receiverEmail (Thymeleaf):", receiverEmail);
      // console.log("  - isChatMode:", isChatMode);
      // console.log("  - senderEmail íƒ€ì…:", typeof senderEmail);
      // console.log("  - receiverEmail íƒ€ì…:", typeof receiverEmail);
      // console.log("========================================");

      // ë””ë²„ê¹… ì •ë³´ë¥¼ í™”ë©´ì— í‘œì‹œ
      // window.addEventListener('DOMContentLoaded', function() {
      //   const debugInfo = document.createElement('div');
      //   debugInfo.id = 'debugInfo';
      //   debugInfo.style.cssText = 'position: fixed; top: 10px; right: 10px; background: #f7f9f9; padding: 12px; border-radius: 8px; font-size: 12px; z-index: 1000; max-width: 300px; border: 1px solid #eff3f4;';
      //   debugInfo.innerHTML = `
      //     <strong>ğŸ” ë””ë²„ê¹… ì •ë³´</strong><br/>
      //     senderEmail: ${senderEmail || '(ì—†ìŒ)'}<br/>
      //     receiverEmail: ${receiverEmail || '(ì—†ìŒ)'}<br/>
      //     <button onclick="this.parentElement.style.display='none'" style="margin-top: 8px; padding: 4px 8px; font-size: 11px;">ë‹«ê¸°</button>
      //   `;
      //   document.body.appendChild(debugInfo);
      // });

      function getNormalizedRoomName(user1, user2) {
        return user1 < user2 ? user1 + '_' + user2 : user2 + '_' + user1;
      }

      function connect() {
        console.log("[DEBUG] connect() í•¨ìˆ˜ í˜¸ì¶œë¨");
        
        // ì „ì—­ ë³€ìˆ˜ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
        const currentSenderEmail = window.senderEmail || senderEmail;
        const currentReceiverEmail = window.receiverEmail || receiverEmail;
        
        console.log("  - senderEmail:", currentSenderEmail);
        console.log("  - receiverEmail:", currentReceiverEmail);
        
        if (!currentSenderEmail || !currentReceiverEmail) {
          console.error("ì‚¬ìš©ì ì •ë³´ê°€ ì—†ì–´ ì—°ê²°í•  ìˆ˜ ì—†ìŒ");
          return;
        }
        
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        
        stompClient.connect({}, function (frame) {
          console.log('Connected: ' + frame);
          
          roomName = getNormalizedRoomName(currentSenderEmail, currentReceiverEmail);
          
          // ì±„íŒ…ë°© êµ¬ë…
          stompClient.subscribe('/topic/' + roomName, function (message) {
            const data = JSON.parse(message.body);
            displayMessage(data);
          });
          
          // ê¸°ì¡´ ë©”ì‹œì§€ ë¡œë“œ
          loadMessageHistory();
        }, function(error) {
          console.error('WebSocket ì—°ê²° ì˜¤ë¥˜:', error);
          document.getElementById('chatMessages').innerHTML = 
            '<div class="loading">ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.</div>';
        });
      }

      function loadMessageHistory() {
        console.log("[DEBUG] loadMessageHistory() í•¨ìˆ˜ í˜¸ì¶œë¨");
        
        // ì „ì—­ ë³€ìˆ˜ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
        const currentSenderEmail = window.senderEmail || senderEmail;
        const currentReceiverEmail = window.receiverEmail || receiverEmail;
        
        console.log("  - senderEmail:", currentSenderEmail);
        console.log("  - receiverEmail:", currentReceiverEmail);
        
        if (!currentSenderEmail || currentSenderEmail.trim() === '') {
          console.error("senderEmailì´ ë¹„ì–´ìˆìŒ");
          document.getElementById('chatMessages').innerHTML = 
            '<div class="loading" style="color: #f4212e;">ì˜¤ë¥˜: ë°œì‹ ì ì´ë©”ì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }
        
        if (!currentReceiverEmail || currentReceiverEmail.trim() === '') {
          console.error("receiverEmailì´ ë¹„ì–´ìˆìŒ");
          document.getElementById('chatMessages').innerHTML = 
            '<div class="loading" style="color: #f4212e;">ì˜¤ë¥˜: ìˆ˜ì‹ ì ì´ë©”ì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }
        
        const url = `/api/messages/history?sender=${encodeURIComponent(currentSenderEmail)}&receiver=${encodeURIComponent(currentReceiverEmail)}`;
        console.log("  - ìš”ì²­ URL:", url);
        
        fetch(url)
          .then(response => {
            console.log("  - ì‘ë‹µ ìƒíƒœ ì½”ë“œ:", response.status);
            console.log("  - ì‘ë‹µ OK:", response.ok);
            
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
          })
          .then(messages => {
            console.log("  ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ ë¡œë“œ ì„±ê³µ:", messages);
            console.log("  - ë©”ì‹œì§€ ê°œìˆ˜:", messages ? messages.length : 0);
            
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';
            
            if (messages && messages.length > 0) {
              messages.forEach(message => {
                displayMessage(message);
              });
              scrollToBottom();
            } else {
              messagesContainer.innerHTML = '<div class="loading">ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
          })
          .catch(error => {
            console.error('ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ ë¡œë“œ ì˜¤ë¥˜:', error);
            console.error('  - ì—ëŸ¬ ë©”ì‹œì§€:', error.message);
            console.error('  - ì—ëŸ¬ ìŠ¤íƒ:', error.stack);
            document.getElementById('chatMessages').innerHTML = 
              `<div class="loading" style="color: #f4212e;">ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br/>${error.message}</div>`;
          });
      }

      function displayMessage(message) {
        const messagesContainer = document.getElementById('chatMessages');
        const loadingDiv = messagesContainer.querySelector('.loading');
        if (loadingDiv) {
          loadingDiv.remove();
        }
        
        // ì „ì—­ ë³€ìˆ˜ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
        const currentSenderEmail = window.senderEmail || senderEmail;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message ' + (message.sender === currentSenderEmail ? 'sent' : 'received');
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        
        // ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ì´ë¯¸ì§€ í‘œì‹œ
        if (message.imagePath) {
          const imageDiv = document.createElement('div');
          const img = document.createElement('img');
          img.src = message.imagePath;
          img.alt = 'ë©”ì‹œì§€ ì´ë¯¸ì§€';
          img.className = 'message-image';
          img.onclick = function() {
            // ì´ë¯¸ì§€ í´ë¦­ ì‹œ í™•ëŒ€ ë³´ê¸° (ì„ íƒì )
            window.open(message.imagePath, '_blank');
          };
          imageDiv.appendChild(img);
          contentDiv.appendChild(imageDiv);
        }
        
        // í…ìŠ¤íŠ¸ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ í‘œì‹œ
        if (message.content && message.content.trim() !== '') {
          const textDiv = document.createElement('div');
          textDiv.textContent = message.content;
          contentDiv.appendChild(textDiv);
        }
        
        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        if (message.timestamp) {
          const date = new Date(message.timestamp);
          timeDiv.textContent = date.toLocaleTimeString('ko-KR', { 
            hour: '2-digit', 
            minute: '2-digit' 
          });
        }
        
        messageDiv.appendChild(contentDiv);
        messageDiv.appendChild(timeDiv);
        messagesContainer.appendChild(messageDiv);
        
        scrollToBottom();
      }

      // ì´ë¯¸ì§€ ì„ íƒ ì²˜ë¦¬
      let selectedImageFile = null;
      let selectedImagePath = null;

      function handleImageSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        // íŒŒì¼ í¬ê¸° ì œí•œ (10MB)
        if (file.size > 10 * 1024 * 1024) {
          alert('ì´ë¯¸ì§€ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
          event.target.value = '';
          return;
        }

        selectedImageFile = file;
        const previewContainer = document.getElementById('imagePreviewContainer');
        
        // ë¯¸ë¦¬ë³´ê¸° ìƒì„±
        const reader = new FileReader();
        reader.onload = function(e) {
          previewContainer.innerHTML = `
            <div class="image-preview-container">
              <img src="${e.target.result}" alt="ë¯¸ë¦¬ë³´ê¸°" class="image-preview">
              <button class="image-preview-remove" onclick="removeImagePreview()">Ã—</button>
            </div>
          `;
          previewContainer.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }

      function removeImagePreview() {
        selectedImageFile = null;
        selectedImagePath = null;
        document.getElementById('imageInput').value = '';
        document.getElementById('imagePreviewContainer').innerHTML = '';
        document.getElementById('imagePreviewContainer').style.display = 'none';
      }

      async function sendMessage() {
        const input = document.getElementById('messageInput');
        if (!input) {
          console.warn("messageInput ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        
        const messageContent = input.value.trim();
        
        // í…ìŠ¤íŠ¸ì™€ ì´ë¯¸ì§€ê°€ ëª¨ë‘ ì—†ìœ¼ë©´ ì „ì†¡í•˜ì§€ ì•ŠìŒ
        if ((!messageContent || messageContent.trim() === '') && !selectedImageFile) {
          return;
        }
        
        if (!stompClient) {
          console.warn("WebSocket ì—°ê²°ì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        
        // ì „ì—­ ë³€ìˆ˜ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
        const currentSenderEmail = window.senderEmail || senderEmail;
        const currentReceiverEmail = window.receiverEmail || receiverEmail;
        
        try {
          let imagePath = null;
          
          // ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ë¨¼ì € ì—…ë¡œë“œ
          if (selectedImageFile) {
            console.log("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œì‘...");
            const formData = new FormData();
            formData.append('file', selectedImageFile);
            formData.append('userEmail', currentSenderEmail);
            
            const uploadResponse = await fetch('/api/messages/upload-image', {
              method: 'POST',
              body: formData
            });
            
            if (!uploadResponse.ok) {
              throw new Error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨');
            }
            
            const uploadResult = await uploadResponse.json();
            imagePath = uploadResult.imagePath;
            console.log("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ:", imagePath);
          }
          
          // ë©”ì‹œì§€ ì „ì†¡
          const message = {
            sender: currentSenderEmail,
            receiver: currentReceiverEmail,
            content: messageContent || '',
            timestamp: new Date().toISOString()
          };
          
          if (imagePath) {
            message.imagePath = imagePath;
          }
          
          stompClient.send('/app/chat/' + roomName + '/sendMessage', {}, JSON.stringify(message));
          
          // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
          input.value = '';
          input.style.height = 'auto';
          removeImagePreview();
          scrollToBottom();
          
        } catch (error) {
          console.error('ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜:', error);
          alert('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: ' + error.message);
        }
      }

      function scrollToBottom() {
        const messagesContainer = document.getElementById('chatMessages');
        if (messagesContainer) {
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
      }

      // Enter í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡ (Shift+EnterëŠ” ì¤„ë°”ê¿ˆ)
      // ì±„íŒ… ëª¨ë“œì—ì„œë§Œ messageInput ìš”ì†Œê°€ ì¡´ì¬í•˜ë¯€ë¡œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
      const messageInput = document.getElementById('messageInput');
      if (messageInput) {
        messageInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });

        // í…ìŠ¤íŠ¸ ì˜ì—­ ìë™ ë†’ì´ ì¡°ì ˆ
        messageInput.addEventListener('input', function() {
          this.style.height = 'auto';
          this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
      }

      // ëª©ë¡ ëª¨ë“œë¡œ ì´ë™
      function goToListMode() {
        window.location.href = '/chat/message';
      }

      // ëŒ€í™” ìƒëŒ€ ëª©ë¡ ë¡œë“œ
      function loadConversations() {
        console.log("[DEBUG] loadConversations() í•¨ìˆ˜ í˜¸ì¶œë¨");
        
        // ëª©ë¡ ëª¨ë“œìš© data ì†ì„±ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
        const listModeData = document.getElementById('listModeData');
        let currentSenderEmail = window.senderEmail || senderEmail;
        
        if (listModeData) {
          const dataSender = listModeData.getAttribute('data-sender-email');
          console.log("  - listModeDataì—ì„œ ê°€ì ¸ì˜¨ senderEmail:", dataSender);
          if (dataSender) {
            currentSenderEmail = dataSender;
            window.senderEmail = dataSender;
          }
        }
        
        console.log("  - ìµœì¢… currentSenderEmail:", currentSenderEmail);
        
        if (!currentSenderEmail || currentSenderEmail.trim() === '') {
          console.error("âŒ senderEmailì´ ë¹„ì–´ìˆì–´ ëŒ€í™” ìƒëŒ€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŒ");
          document.getElementById('conversationList').innerHTML = 
            '<div class="empty-conversations">ì˜¤ë¥˜: ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br/>senderEmail: ' + (currentSenderEmail || '(ì—†ìŒ)') + '</div>';
          return;
        }

        // ì„¸ì…˜ ìœ ì €ì˜ message_entityë¥¼ ì¡°íšŒí•˜ì—¬ ëŒ€í™” ìƒëŒ€ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        // API: /api/messages/conversations?userEmail={ì„¸ì…˜ìœ ì €ì´ë©”ì¼}
        const url = `/api/messages/conversations?userEmail=${encodeURIComponent(currentSenderEmail)}`;
        console.log("  - ìš”ì²­ URL:", url);
        console.log("  - ì„¸ì…˜ ìœ ì € (senderEmail):", currentSenderEmail);

        fetch(url)
          .then(response => {
            console.log("  - ì‘ë‹µ ìƒíƒœ ì½”ë“œ:", response.status);
            console.log("  - ì‘ë‹µ OK:", response.ok);
            console.log("  - ì‘ë‹µ Content-Type:", response.headers.get('Content-Type'));
            
            if (!response.ok) {
              return response.text().then(text => {
                console.error("  âŒ API ì˜¤ë¥˜ ì‘ë‹µ:", text);
                throw new Error(`HTTP ${response.status}: ${response.statusText} - ${text}`);
              });
            }
            return response.json();
          })
          .then(conversations => {
            console.log("  âœ… ëŒ€í™” ìƒëŒ€ ëª©ë¡ ë¡œë“œ ì„±ê³µ");
            console.log("  - ì‘ë‹µ íƒ€ì…:", typeof conversations);
            console.log("  - ì‘ë‹µ ë°ì´í„°:", JSON.stringify(conversations, null, 2));
            console.log("  - ëŒ€í™” ìƒëŒ€ ìˆ˜:", conversations ? conversations.length : 0);
            
            const listContainer = document.getElementById('conversationList');
            if (!listContainer) {
              console.error("  âŒ conversationList ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ");
              return;
            }
            
            listContainer.innerHTML = '';
            
            if (conversations && Array.isArray(conversations) && conversations.length > 0) {
              console.log("  âœ… ëŒ€í™” ìƒëŒ€ ëª©ë¡ ë Œë”ë§ ì‹œì‘");
              conversations.forEach((conversation, index) => {
                console.log(`  - ëŒ€í™” ìƒëŒ€ [${index}]:`, conversation);
                
                const item = document.createElement('div');
                item.className = 'conversation-item';
                item.onclick = function() {
                  // ëª©ë¡ì—ì„œ ìƒëŒ€ë°©ì„ í´ë¦­í•˜ë©´:
                  // - senderEmail: ì„¸ì…˜ ìœ ì € (í˜„ì¬ ë¡œê·¸ì¸í•œ ìœ ì €, window.senderEmail)
                  // - receiverEmail: í´ë¦­í•œ ìƒëŒ€ë°© (conversation.otherUserEmail)
                  const currentSenderEmail = window.senderEmail || senderEmail;
                  const receiverEmail = conversation.otherUserEmail;
                  console.log("  - ëŒ€í™” ìƒëŒ€ í´ë¦­");
                  console.log("    - senderEmail (ì„¸ì…˜ ìœ ì €):", currentSenderEmail);
                  console.log("    - receiverEmail (ìƒëŒ€ë°©):", receiverEmail);
                  // ì±„íŒ… ëª¨ë“œë¡œ ì´ë™: /chat/message?receiverEmail={ìƒëŒ€ë°©ì´ë©”ì¼}
                  window.location.href = `/chat/message?receiverEmail=${encodeURIComponent(receiverEmail)}`;
                };
                
                // ì•„ë°”íƒ€ (ì´ë¦„ ì²« ê¸€ì)
                const avatar = document.createElement('div');
                avatar.className = 'conversation-avatar';
                avatar.textContent = conversation.otherUserName ? conversation.otherUserName.charAt(0).toUpperCase() : '?';
                
                // ë‚´ìš©
                const content = document.createElement('div');
                content.className = 'conversation-content';
                
                const name = document.createElement('div');
                name.className = 'conversation-name';
                name.textContent = conversation.otherUserName || conversation.otherUserEmail;
                
                const preview = document.createElement('div');
                preview.className = 'conversation-preview';
                preview.textContent = conversation.lastMessage || '';
                
                content.appendChild(name);
                content.appendChild(preview);
                
                // ì‹œê°„
                const time = document.createElement('div');
                time.className = 'conversation-time';
                if (conversation.lastMessageTime) {
                  const date = new Date(conversation.lastMessageTime);
                  const now = new Date();
                  const diff = now - date;
                  const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                  
                  if (days === 0) {
                    time.textContent = date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                  } else if (days === 1) {
                    time.textContent = 'ì–´ì œ';
                  } else if (days < 7) {
                    time.textContent = days + 'ì¼ ì „';
                  } else {
                    time.textContent = date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
                  }
                }
                
                item.appendChild(avatar);
                item.appendChild(content);
                item.appendChild(time);
                listContainer.appendChild(item);
              });
            } else {
              console.log("  âš ï¸ ëŒ€í™” ìƒëŒ€ê°€ ì—†ìŒ");
              listContainer.innerHTML = '<div class="empty-conversations">ë©”ì‹œì§€ë¥¼ ì£¼ê³ ë°›ì€ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
          })
          .catch(error => {
            console.error('âŒ ëŒ€í™” ìƒëŒ€ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
            console.error('  - ì—ëŸ¬ ë©”ì‹œì§€:', error.message);
            console.error('  - ì—ëŸ¬ ìŠ¤íƒ:', error.stack);
            const listContainer = document.getElementById('conversationList');
            if (listContainer) {
              listContainer.innerHTML = 
                `<div class="empty-conversations">ëŒ€í™” ìƒëŒ€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br/>${error.message}</div>`;
            }
          });
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì—°ê²°
      window.onload = function() {
        console.log("[DEBUG] window.onload ì‹¤í–‰ë¨");
        console.log("  - isChatMode:", isChatMode);
        
        // data ì†ì„±ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸° (Thymeleaf ì¸ë¼ì¸ ì‹¤íŒ¨ ì‹œ ëŒ€ë¹„)
        const debugData = document.getElementById('debugData');
        const listModeData = document.getElementById('listModeData');
        let finalSenderEmail = senderEmail;
        let finalReceiverEmail = receiverEmail;
        
        // ì±„íŒ… ëª¨ë“œìš© ë°ì´í„°
        if (debugData) {
          const dataSender = debugData.getAttribute('data-sender-email');
          const dataReceiver = debugData.getAttribute('data-receiver-email');
          console.log("  - debugData data-sender-email:", dataSender);
          console.log("  - debugData data-receiver-email:", dataReceiver);
          
          if ((!finalSenderEmail || finalSenderEmail.trim() === '') && dataSender) {
            console.log("  âš ï¸ senderEmailì´ ë¹„ì–´ìˆì–´ debugDataì—ì„œ ê°€ì ¸ì˜´");
            finalSenderEmail = dataSender;
          }
          
          if ((!finalReceiverEmail || finalReceiverEmail.trim() === '') && dataReceiver) {
            console.log("  âš ï¸ receiverEmailì´ ë¹„ì–´ìˆì–´ debugDataì—ì„œ ê°€ì ¸ì˜´");
            finalReceiverEmail = dataReceiver;
          }
        }
        
        // ëª©ë¡ ëª¨ë“œìš© ë°ì´í„°
        if (listModeData) {
          const dataSender = listModeData.getAttribute('data-sender-email');
          console.log("  - listModeData data-sender-email:", dataSender);
          
          if ((!finalSenderEmail || finalSenderEmail.trim() === '') && dataSender) {
            console.log("  âš ï¸ senderEmailì´ ë¹„ì–´ìˆì–´ listModeDataì—ì„œ ê°€ì ¸ì˜´");
            finalSenderEmail = dataSender;
          }
        }
        
        console.log("  - ìµœì¢… senderEmail:", finalSenderEmail);
        console.log("  - ìµœì¢… receiverEmail:", finalReceiverEmail);
        
        // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
        if (finalSenderEmail) {
          window.senderEmail = finalSenderEmail;
        }
        if (finalReceiverEmail) {
          window.receiverEmail = finalReceiverEmail;
        }
        
        // ëª¨ë“œì— ë”°ë¼ ë‹¤ë¥¸ ë™ì‘
        if (isChatMode && finalReceiverEmail) {
          // ì±„íŒ… ëª¨ë“œ
          console.log("  âœ… ì±„íŒ… ëª¨ë“œ - WebSocket ì—°ê²° ì‹œì‘");
          if (!finalSenderEmail || finalSenderEmail.trim() === '') {
            console.error("âŒ senderEmailì´ ë¹„ì–´ìˆìŒ");
            document.getElementById('chatMessages').innerHTML = 
              '<div class="loading" style="color: #f4212e;">ì˜¤ë¥˜: ë°œì‹ ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
          }
          connect();
        } else {
          // ëª©ë¡ ëª¨ë“œ
          console.log("  âœ… ëª©ë¡ ëª¨ë“œ - ëŒ€í™” ìƒëŒ€ ëª©ë¡ ë¡œë“œ");
          loadConversations();
        }
      };
    </script>
  </body>
</html>

