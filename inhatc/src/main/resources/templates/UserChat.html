<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Page</title>
    <!-- Webjars를 통해 SockJS 및 STOMP 클라이언트 로드 -->
    <script th:src="@{/webjars/sockjs-client/sockjs.min.js}"></script>
    <script th:src="@{/webjars/stomp-websocket/stomp.min.js}"></script>
    <style>
      .chat-container {
        width: 500px;
        margin: 50px auto;
        border: 1px solid #ccc;
        display: flex;
        flex-direction: column;
        height: 600px;
      }
      .chat-header {
        background-color: #f5f5f5;
        padding: 15px;
        text-align: center;
        font-size: 20px;
        font-weight: bold;
        border-bottom: 1px solid #ccc;
      }
      .chat-messages {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        background-color: #fff;
      }
      .message {
        margin-bottom: 10px;
        max-width: 70%;
        word-wrap: break-word;
        padding: 10px;
        border-radius: 10px;
        clear: both;
      }
      .sent {
        background-color: #dcf8c6;
        align-self: flex-end;
        margin-left: auto;
        text-align: right;
      }
      .received {
        background-color: #f1f0f0;
        align-self: flex-start;
        margin-right: auto;
        text-align: left;
      }
      .chat-input-container {
        display: flex;
        padding: 10px;
        border-top: 1px solid #ccc;
        background-color: #f5f5f5;
      }
      #chat-input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        resize: none;
      }
      #send-button {
        margin-left: 10px;
        padding: 10px 20px;
        border: none;
        background-color: #4caf50;
        color: #fff;
        border-radius: 5px;
        cursor: pointer;
      }
      #send-button:hover {
        background-color: #45a049;
      }
      .navbar {
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #ffffff;
        padding: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        margin-bottom: 20px;
      }
      .navbar img {
        width: 60px;
        height: 60px;
        margin: 0 20px;
        cursor: pointer;
      }
      .navbar a {
        color: white;
        text-decoration: none;
        font-size: 18px;
        margin: 0 15px;
      }
      .profile-img {
        width: 200px;
        height: 200px;
        object-fit: cover;
        border-radius: 50%;
        display: block;
        margin: 0 auto;
      }
      .content-img {
        width: calc(200px - 20px);
        height: calc(200px - 20px);
        object-fit: cover;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div class="navbar">
      <!-- Home 버튼 -->
      <img
        th:src="@{/images/home.png}"
        style="height: 55px; width: 55px"
        alt="home"
        th:onclick="|location.href='@{/member/view}';|"
      />
      <!-- User Profile 버튼 -->
      <img
        th:src="@{/images/user.png}"
        alt="User Image"
        th:onclick="|location.href='@{/member/mypage}';|"
      />
      <!-- Logout 버튼 -->
      <img
        th:src="@{/images/logout.png}"
        style="width: 50px; height: 50px"
        alt="Logout"
        th:onclick="|document.getElementById('logout').submit();|"
      />
      <form id="logout" th:action="@{/member/logout}" method="post"></form>
      <!-- Alarm 버튼 -->
      <img
        th:src="@{/images/alram.png}"
        alt="Alarm"
        th:onclick="|location.href='@{/member/PostCheck}';|"
      />
    </div>

    <div class="chat-container">
      <div class="chat-header">
        <!-- 채팅 상대방 이름 -->
        <span id="chattingWith">
          <span th:text="${sender}">유저</span>가
          <span th:text="${receiver}">상대방</span>에게 채팅방
        </span>
      </div>
      <div class="chat-messages" id="chat-messages">
        <!-- 채팅 메시지가 여기에 표시됩니다 -->
        <div th:each="message : ${chatMessages}">
          <p th:text="${message}"></p>
        </div>
      </div>
      <div class="chat-input-container">
        <!-- 메시지 입력 -->
        <textarea
          id="chat-input"
          placeholder="메시지를 입력하세요..."
        ></textarea>
        <button id="send-button">전송</button>
      </div>
    </div>

    <script>
      let stompClient = null;
      let sessionEmail = "";
      window.addEventListener("load", function () {
        fetchMemberEmail().then(() => {
          const { senderID, receiverID } = getQueryParams();
          if (senderID && receiverID) {
            connectToChatRoom(senderID, receiverID);
          } else {
            console.error("Sender ID or Receiver ID is missing.");
            alert("Sender ID or Receiver ID is missing in the URL.");
          }
        });
      });

      async function fetchMemberEmail() {
        try {
          const response = await fetch("/gettingSession");
          const data = await response.json();
          if (data.loginEmail) {
            saveMemberEmail(data.loginEmail);
          } else {
            console.error("사용자 이메일을 찾을 수 없습니다.");
          }
        } catch (error) {
          console.error("memberEmail을 가져오는 중 에러:", error);
        }
      }

      function saveMemberEmail(memberEmail) {
        sessionEmail = memberEmail;
        sessionStorage.setItem("memberEmail", memberEmail);
        console.log("memberEmail 저장됨:", memberEmail);
      }

      function getQueryParams() {
        const params = new URLSearchParams(window.location.search);
        const senderID = params.get("senderID");
        const receiverID = params.get("receiverID");
        console.log("Sender ID:", senderID); // 디버깅용
        console.log("Receiver ID:", receiverID); // 디버깅용
        return { senderID, receiverID };
      }

      function connectToChatRoom(senderId, receiverId) {
        console.log("Connecting to chat room with:", senderId, receiverId); // 디버깅
        const roomName = getNormalizedRoomName(senderId, receiverId);
        const socket = new SockJS("/ws");
        stompClient = Stomp.over(socket);

        stompClient.connect(
          {},
          function (frame) {
            console.log("Connected: " + frame);

            // 채팅방 시작 메시지 전송
            stompClient.send(
              `/app/chat/${receiverId}/start`,
              { username: senderId },
              JSON.stringify({ sender: senderId, receiver: receiverId })
            );

            // 채팅 메시지 구독
            stompClient.subscribe(`/topic/${roomName}`, function (message) {
              showMessage(JSON.parse(message.body));
            });

            // 채팅 기록 가져오기
            fetchChatHistory(senderId, receiverId);
          },
          function (error) {
            console.error("웹소켓 연결 오류:", error);
          }
        );
      }

      function sendMessageToRoom(senderId, receiverId, messageContent) {
        const roomName = getNormalizedRoomName(senderId, receiverId);
        if (stompClient && messageContent.trim() !== "") {
          const chatMessage = {
            sender: senderId,
            receiver: receiverId,
            content: messageContent,
            timestamp: new Date().toISOString(),
          };
          stompClient.send(
            `/app/chat/${roomName}/sendMessage`,
            { username: senderId }, // 메시지 헤더에 senderId 추가
            JSON.stringify(chatMessage)
          );
        }
      }

      function getNormalizedRoomName(userId1, userId2) {
        // 두 아이디를 알파벳순으로 정렬하여 동일한 룸 이름 생성
        return [userId1, userId2].sort().join("_");
      }

      function isSender(userId) {
        // 현재 사용자가 발신자인지 확인
        return window.location.search.includes(`senderID=${userId}`);
      }

      function fetchChatHistory(senderId, receiverId) {
        fetch(`/api/chat/history?sender=${senderId}&receiver=${receiverId}`)
          .then((response) => response.json())
          .then((messages) => {
            if (Array.isArray(messages)) {
              messages.forEach((message) => {
                const isSent = message.sender === senderId;
                showMessage(message, isSent);
              });
              scrollToBottom();
            } else {
              console.error("Unexpected data format:", messages);
            }
          })
          .catch((error) => {
            console.error("Error fetching chat history:", error);
            alert("Failed to load chat history.");
          });
      }

      function scrollToBottom() {
        const chatMessages = document.getElementById("chat-messages");
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function showMessage(message, isSent) {
        const messageElement = document.createElement("div");
        const isSenderMessage = message.sender === sessionEmail;
        messageElement.classList.add(
          "message",
          isSenderMessage ? "sent" : "received"
        );
        messageElement.textContent = message.content;
        document.getElementById("chat-messages").appendChild(messageElement);
      }

      // 페이지 로드 시 세션 이메일 가져오기

      // 메시지 전송 버튼 클릭 이벤트
      document
        .getElementById("send-button")
        .addEventListener("click", function () {
          const { senderID, receiverID } = getQueryParams();
          const messageContent = document.getElementById("chat-input").value;
          if (messageContent.trim() !== "") {
            sendMessageToRoom(senderID, receiverID, messageContent);
            document.getElementById("chat-input").value = "";
          }
        });

      // 엔터키로 메시지 전송
      document
        .getElementById("chat-input")
        .addEventListener("keydown", function (event) {
          if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault();
            document.getElementById("send-button").click();
          }
        });
    </script>
  </body>
</html>

