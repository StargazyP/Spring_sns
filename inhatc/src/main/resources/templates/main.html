<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ê²Œì‹œë¬¼ ê´€ë¦¬</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background-color: #ffffff;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        color: #0f1419;
        line-height: 1.5;
        min-height: 100vh;
        padding: 0;
        margin: 0;
      }

      .wrapper {
        max-width: 600px;
        margin: 0 auto;
        background-color: #ffffff;
        min-height: 100vh;
        border-left: 1px solid #eff3f4;
        border-right: 1px solid #eff3f4;
      }

      .container {
        padding: 12px 16px;
        border-bottom: 1px solid #eff3f4;
      }

      /* X ìŠ¤íƒ€ì¼ ë„¤ë¹„ê²Œì´ì…˜ ë°” */
      .navbar {
        position: sticky;
        top: 0;
        background-color: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(12px);
        border-bottom: 1px solid #eff3f4;
        padding: 16px 20px;
        display: flex;
        justify-content: space-around;
        align-items: center;
        z-index: 100;
        min-height: 64px;
        gap: 20px;
      }

      .navbar img {
        cursor: pointer;
        padding: 10px;
        border-radius: 50%;
        transition: background-color 0.2s;
        object-fit: contain;
      }

      .navbar img:hover {
        background-color: #f7f9f9;
      }

      /* home.png: 256x256 (1:1) - 30% ì¦ê°€ */
      .navbar img[src="/images/home.png"] {
        width: 52px;
        height: 52px;
      }

      /* user.png: 700x594 (ì•½ 1.18:1) - 30% ì¦ê°€ */
      .navbar img[src="/images/user.png"] {
        width: 61px;
        height: 52px;
      }

      /* Message.png: 512x512 (1:1) - 30% ì¦ê°€ */
      .navbar img[src="/Message.png"] {
        width: 52px;
        height: 52px;
      }

      /* alram.png: 700x590 (ì•½ 1.19:1) - 30% ì¦ê°€ */
      .navbar img[src="/images/alram.png"] {
        width: 61px;
        height: 52px;
        position: relative;
      }
      
      /* ì•Œë¦¼ ë°°ì§€ ìŠ¤íƒ€ì¼ */
      .notification-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        background-color: #ef4444;
        color: white;
        border-radius: 50%;
        min-width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        padding: 0 6px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        z-index: 101;
        opacity: 0;
        transform: scale(0);
        transition: opacity 0.3s, transform 0.3s;
      }
      
      .notification-badge.show {
        opacity: 1;
        transform: scale(1);
      }
      
      .notification-icon-container {
        position: relative;
        display: inline-block;
      }
      
      .notification-icon-container img {
        cursor: pointer;
      }

      /* logout.png - 30% ì¦ê°€ */
      .navbar img[src="/images/logout.png"] {
        width: 52px;
        height: 52px;
      }

      /* ê²Œì‹œë¬¼ ì‘ì„± í¼ */
      #postForm {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 12px 0;
      }

      #content {
        width: 100%;
        padding: 12px;
        border: none;
        font-size: 20px;
        resize: none;
        outline: none;
        font-family: inherit;
        color: #0f1419;
        background-color: transparent;
        min-height: 120px;
      }

      #content::placeholder {
        color: #536471;
      }

      #fileUpload {
        display: none; /* íŒŒì¼ ì…ë ¥ì„ ìˆ¨ê¹€ */
      }

      /* ì´ë¯¸ì§€ ì—…ë¡œë“œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (message.htmlê³¼ ë™ì¼) */
      .image-upload-button {
        padding: 8px 12px;
        background-color: #f7f9f9;
        color: #0f1419;
        border: 1px solid #eff3f4;
        border-radius: 20px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
        margin-top: 8px;
      }

      .image-upload-button:hover {
        background-color: #eff3f4;
      }

      button {
        background-color: #0f1419;
        color: #ffffff;
        border: none;
        border-radius: 24px;
        padding: 10px 24px;
        font-size: 15px;
        font-weight: 700;
        cursor: pointer;
        transition: background-color 0.2s;
        align-self: flex-end;
        margin-top: 8px;
      }

      button:hover {
        background-color: #272c30;
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* ê²Œì‹œë¬¼ ì¹´ë“œ */
      .card {
        padding: 12px 16px;
        border-bottom: 1px solid #eff3f4;
        cursor: pointer;
        transition: background-color 0.2s;
        position: relative;
        display: flex;
        gap: 12px;
      }

      .card:hover {
        background-color: #f7f9f9;
      }

      .profile-img {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        object-fit: cover;
        flex-shrink: 0;
      }

      .card-content {
        flex: 1;
        min-width: 0;
      }

      .card-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
      }

      .card-header a {
        font-size: 15px;
        font-weight: 700;
        color: #0f1419;
        text-decoration: none;
      }

      .card-header a:hover {
        text-decoration: underline;
      }

      .card-body {
        font-size: 15px;
        color: #0f1419;
        margin: 8px 0;
        word-wrap: break-word;
      }

      .card-date {
        font-size: 15px;
        color: #536471;
        margin-bottom: 4px;
      }

      .content-img {
        width: 100%;
        max-width: 100%;
        border-radius: 16px;
        margin-top: 12px;
        object-fit: cover;
        max-height: 400px;
      }

      .close-button {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #536471;
        cursor: pointer;
        transition: background-color 0.2s, color 0.2s;
        font-size: 18px;
        z-index: 10;
      }

      .close-button:hover {
        background-color: #f4212e;
        color: #ffffff;
      }

      /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(4px);
      }

      .modal-content {
        background-color: #ffffff;
        margin: 40px auto;
        padding: 0;
        border-radius: 16px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      }

      .modal-content .close {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #536471;
        font-size: 24px;
        font-weight: normal;
        cursor: pointer;
        transition: background-color 0.2s;
        z-index: 10;
      }

      .modal-content .close:hover {
        background-color: #f7f9f9;
      }

      #postDetail {
        padding: 16px;
      }

      #postDetail h2 {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 12px;
      }

      #postDetail h2 a {
        color: #0f1419;
        text-decoration: none;
      }

      #postDetail h2 a:hover {
        text-decoration: underline;
      }

      #postDetail p {
        font-size: 15px;
        color: #0f1419;
        margin: 8px 0;
      }

      /* ëŒ“ê¸€ ì„¹ì…˜ */
      #commentSection {
        border-top: 1px solid #eff3f4;
        padding: 16px;
      }

      #comments {
        max-height: 400px;
        overflow-y: auto;
        margin-bottom: 16px;
      }

      .comment {
        padding: 12px 0;
        border-bottom: 1px solid #eff3f4;
        display: flex;
        gap: 12px;
      }

      .comment:last-child {
        border-bottom: none;
      }

      .comment .profile-img {
        width: 40px;
        height: 40px;
      }

      .comment p {
        font-size: 15px;
        color: #0f1419;
        margin: 4px 0;
      }

      .comment strong {
        color: #0f1419;
        font-weight: 700;
      }

      #commentForm {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      #commentContent {
        width: 100%;
        padding: 12px;
        border: 1px solid #eff3f4;
        border-radius: 8px;
        font-size: 15px;
        resize: none;
        outline: none;
        font-family: inherit;
        min-height: 80px;
      }

      #commentContent:focus {
        border-color: #1d9bf0;
      }

      /* ì•Œë¦¼ ëª¨ë‹¬ */
      #notificationModal .modal-content {
        max-width: 600px;
      }

      .notification-item {
        padding: 16px;
        border-bottom: 1px solid #eff3f4;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .notification-item:hover {
        background-color: #f7f9f9;
      }

      .notification-item:last-child {
        border-bottom: none;
      }

      /* í† ê¸€ ì»¨í…Œì´ë„ˆ */
      .toggle-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #ffffff;
        border-radius: 24px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        padding: 8px;
        z-index: 1000;
        border: 1px solid #eff3f4;
      }

      .toggle-item {
        padding: 12px 16px;
        cursor: pointer;
        border-radius: 20px;
        background-color: transparent;
        text-align: center;
        font-size: 15px;
        font-weight: 500;
        color: #0f1419;
        transition: background-color 0.2s;
        margin-bottom: 4px;
      }

      .toggle-item:last-child {
        margin-bottom: 0;
      }

      .toggle-item:hover {
        background-color: #f7f9f9;
      }

      .content-container {
        position: absolute;
        bottom: 100%;
        right: 0;
        width: 360px;
        max-height: 500px;
        background-color: #ffffff;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        margin-bottom: 8px;
        border: 1px solid #eff3f4;
      }

      .content-container .header {
        background-color: #ffffff;
        color: #0f1419;
        padding: 16px;
        font-size: 20px;
        font-weight: 700;
        border-bottom: 1px solid #eff3f4;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .content-container .header .close-button {
        font-size: 20px;
        color: #536471;
        cursor: pointer;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
      }

      .content-container .header .close-button:hover {
        background-color: #f7f9f9;
      }

      .content-container .messages {
        flex: 1;
        padding: 16px;
        overflow-y: auto;
        background-color: #ffffff;
      }

      .content-container .footer {
        background-color: #ffffff;
        padding: 12px 16px;
        border-top: 1px solid #eff3f4;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .content-container .footer textarea {
        flex: 1;
        padding: 12px;
        border: 1px solid #eff3f4;
        border-radius: 24px;
        resize: none;
        font-size: 15px;
        outline: none;
        font-family: inherit;
      }

      .content-container .footer textarea:focus {
        border-color: #1d9bf0;
      }

      .content-container .footer button {
        padding: 8px 16px;
        background-color: #1d9bf0;
        border: none;
        color: white;
        border-radius: 24px;
        cursor: pointer;
        font-weight: 700;
        font-size: 15px;
        transition: background-color 0.2s;
      }

      .content-container .footer button:hover {
        background-color: #1a8cd8;
      }

      .bubble {
        max-width: 75%;
        padding: 12px 16px;
        border-radius: 20px;
        background-color: #f7f9f9;
        display: inline-block;
        word-wrap: break-word;
        font-size: 15px;
        margin: 4px 0;
      }

      .message.user .bubble {
        background-color: #1d9bf0;
        color: white;
        align-self: flex-end;
      }

      .message .bubble.bot {
        background-color: #f7f9f9;
        color: #0f1419;
        align-self: flex-start;
      }

      #chat-messages {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      /* ì¢‹ì•„ìš” ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
      #postDetail button {
        background-color: transparent;
        color: #536471;
        border: 1px solid #eff3f4;
        border-radius: 20px;
        padding: 8px 16px;
        font-size: 15px;
        font-weight: 500;
        margin-right: 8px;
        transition: all 0.2s;
      }

      #postDetail button:hover {
        background-color: #f7f9f9;
        color: #f4212e;
        border-color: #f4212e;
      }

      #postDetail button[style*="background-color: #dc3545"] {
        background-color: #f4212e;
        color: #ffffff;
        border-color: #f4212e;
      }

      #postDetail button[style*="background-color: #dc3545"]:hover {
        background-color: #d91e2e;
      }

      /* ë°˜ì‘í˜• ë””ìì¸ */
      @media (max-width: 768px) {
        .wrapper {
          max-width: 100%;
          border-left: none;
          border-right: none;
        }

        .modal-content {
          width: 100%;
          margin: 0;
          border-radius: 0;
          max-height: 100vh;
        }

        .content-container {
          width: calc(100vw - 40px);
          max-width: 360px;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <!-- Navigation Bar -->
      <div class="navbar">
        <!-- í™ˆ: ì´ì œ /member/view ëŒ€ì‹  /api/posts ë¡œ ì´ë™ -->
        <img
          src="/images/home.png"
          alt="home"
          onclick="location.href='/main';"
        />

        <!-- ì‚¬ìš©ì ì´ë¯¸ì§€ í´ë¦­: session ê¸°ë°˜ìœ¼ë¡œ MyPageë¡œ ì´ë™ -->
        <img
          src="/images/user.png"
          alt="User"
          onclick="location.href='/member/mypage';"
        />

        <!-- ë©”ì‹œì§€: Message.png -->
        <img
          src="/Message.png"
          alt="Message"
          onclick="location.href='/chat/message';"
        />

        <!-- ì•ŒëŒ / ê²Œì‹œë¬¼ í™•ì¸: /posts/notifications/page -->
        <div class="notification-icon-container">
          <img
            src="/images/alram.png"
            alt="Alarm"
            onclick="location.href='/posts/notifications/page';"
            id="notificationIcon"
          />
          <span id="notificationBadge" class="notification-badge">0</span>
        </div>

        <!-- ë¡œê·¸ì•„ì›ƒ: /member/logout ëŒ€ì‹  /api/logout -->
        <img
          src="/images/logout.png"
          alt="Logout"
          onclick="document.getElementById('logout').submit();"
        />
        <form id="logout" action="/api/members/logout" method="post"></form>
      </div>

      <div class="container">
        <p id="sessionInfo"></p>
        <form id="postForm">
          <div>
            <textarea
              id="content"
              name="content"
              placeholder="ë¬´ìŠ¨ ìƒê°ì„ í•˜ê³  ìˆë‚˜ìš”?"
            ></textarea>
          </div>
          <div>
            <input type="file" id="fileUpload" name="file" accept="image/*" />
            <button type="button" class="image-upload-button" onclick="document.getElementById('fileUpload').click()">
              íŒŒì¼ì—…ë¡œë“œ
            </button>
          </div>
          <button onclick="savePost(event)">ê²Œì‹œí•˜ê¸°</button>
        </form>
      </div>

      <div id="postContainer">
        <!-- Dynamic posts can be inserted here -->
      </div>

      <!-- Modal for displaying post details and comments -->
      <div id="postModal" class="modal">
        <div class="modal-content">
          <span class="close" onclick="closeModal()">&times;</span>
          <div id="postDetail">
            <!-- Post details go here -->
          </div>
          <!-- Comment Section -->
          <div id="commentSection">
            <div id="comments">
              <!-- Comments will be dynamically inserted here -->
            </div>
            <div id="commentForm">
              <textarea
                id="commentContent"
                placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"
              ></textarea>
              <button onclick="submitComment(currentPostId)">ëŒ“ê¸€ ë“±ë¡</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ì•Œë¦¼ ëª¨ë‹¬ -->
      <div id="notificationModal" class="modal">
        <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto; padding: 0;">
          <div style="position: sticky; top: 0; background: white; padding: 16px; border-bottom: 1px solid #eff3f4; z-index: 10;">
            <span class="close" onclick="closeNotificationModal()">&times;</span>
            <h2 style="margin: 0; font-size: 20px; font-weight: 700; color: #0f1419;">ì•Œë¦¼</h2>
          </div>
          <div id="notificationList" style="padding: 0;">
            <!-- ì•Œë¦¼ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
          </div>
        </div>
      </div>
    </div>
    <!-- Toggle Container -->
    <!-- <div class="toggle-container">
      <div class="toggle-list">
        <div id="toggle-chat" class="toggle-item">Chat with GPT</div>
        <div id="toggle-user" class="toggle-item">User</div>
      </div>
      <div id="chat-box" class="content-container chat-box">
        <div class="header">Chat with GPT</div>
        <div class="messages" id="chat-messages"></div>
        <div class="footer">
          <textarea
            id="chat-input"
            placeholder="Type your message here..."
          ></textarea>
          <button id="send-btn">Send</button>
        </div>
      </div>
      <div id="user-box" class="content-container user-box">
        <div class="header">User</div>
        <ul id="user-messages">
           User messages will be displayed here -->
        <!-- </ul>
      </div>
    </div> --> 
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script type="text/javascript">
      // =====================================================
      // WebSocket ì—°ê²° ë° ì•Œë¦¼ ìˆ˜ì‹ 
      // =====================================================
      let stompClient = null;
      let currentUserEmail = null;
      
      function connectWebSocket(email) {
        if (!email) {
          console.warn("ì´ë©”ì¼ì´ ì—†ì–´ WebSocket ì—°ê²°ì„ ê±´ë„ˆëœë‹ˆë‹¤.");
          return;
        }
        
        currentUserEmail = email;
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        
        stompClient.connect({}, function(frame) {
          console.log('WebSocket ì—°ê²°ë¨: ' + frame);
          
          // ì´ë©”ì¼ì„ URL-safeí•˜ê²Œ ë³€í™˜
          const emailPath = email.replace('@', '_').replace(/\./g, '_');
          
          // ì•Œë¦¼ ìˆ˜ êµ¬ë…
          stompClient.subscribe('/topic/notifications/count/' + emailPath, function(message) {
            const count = parseInt(JSON.parse(message.body));
            updateNotificationBadge(count);
          });
          
          // ì•Œë¦¼ ìƒì„¸ ì •ë³´ êµ¬ë… (ì„ íƒì , í•„ìš”ì‹œ ì‚¬ìš©)
          stompClient.subscribe('/topic/notifications/' + emailPath, function(message) {
            const notification = JSON.parse(message.body);
            console.log('ìƒˆ ì•Œë¦¼ ìˆ˜ì‹ :', notification);
            // í•„ìš”ì‹œ ì•Œë¦¼ ìƒì„¸ ì •ë³´ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆìŒ
          });
          
          // ì´ˆê¸° ì•Œë¦¼ ìˆ˜ ì¡°íšŒ
          fetchNotificationCount();
        }, function(error) {
          console.error('WebSocket ì—°ê²° ì˜¤ë¥˜:', error);
          // ì¬ì—°ê²° ì‹œë„ (5ì´ˆ í›„)
          setTimeout(function() {
            if (currentUserEmail) {
              connectWebSocket(currentUserEmail);
            }
          }, 5000);
        });
      }
      
      function disconnectWebSocket() {
        if (stompClient !== null) {
          stompClient.disconnect();
          console.log('WebSocket ì—°ê²° ì¢…ë£Œ');
        }
      }
      
      // í˜ì´ì§€ë¥¼ ë– ë‚  ë•Œ WebSocket ì—°ê²° ì¢…ë£Œ
      window.addEventListener('beforeunload', function() {
        disconnectWebSocket();
      });
      
      function updateNotificationBadge(count) {
        const badge = document.getElementById('notificationBadge');
        if (badge) {
          if (count > 0) {
            badge.textContent = count > 99 ? '99+' : count.toString();
            badge.classList.add('show');
          } else {
            badge.classList.remove('show');
          }
        }
      }
      
      async function fetchNotificationCount() {
        try {
          const response = await fetch('/posts/notifications');
          if (response.ok) {
            const notifications = await response.json();
            updateNotificationBadge(notifications.length);
          }
        } catch (error) {
          console.error('ì•Œë¦¼ ìˆ˜ ì¡°íšŒ ì‹¤íŒ¨:', error);
        }
      }
      
      // =====================================================
      // ì´ˆê¸° ì‹¤í–‰
      // =====================================================
      window.onload = async function () {
        console.log("[window.onload] í˜ì´ì§€ ë¡œë“œ ì‹œì‘");

        try {
          console.log("ì„¸ì…˜ ì´ë©”ì¼ ì •ë³´ ìš”ì²­ ì¤‘...");
          await fetchMemberEmail(); // ì„¸ì…˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ë‚´ë¶€ì—ì„œ WebSocket ì—°ê²°ë¨)

          console.log("ê²Œì‹œë¬¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘...");
          await fetchPosts(); // ê²Œì‹œë¬¼ ë¡œë“œ

          // console.log("ğŸ’¬ ë©”ì‹œì§€ ë¡œë“œ ì‹œì‘...");
          // loadReceivedMessages(); // ë©”ì‹œì§€ ë¡œë“œ

          // ì´ˆê¸° ìƒíƒœ ì„¤ì • (ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ)
          const chatBox = document.getElementById("chat-box");
          const userBox = document.getElementById("user-box");
          if (chatBox) {
            chatBox.style.display = "none";
            console.log("chat-box ì´ˆê¸° ìˆ¨ê¹€ ì™„ë£Œ");
          }
          if (userBox) {
            userBox.style.display = "none";
            console.log("user-box ì´ˆê¸° ìˆ¨ê¹€ ì™„ë£Œ");
          }
          
          // URL íŒŒë¼ë¯¸í„°ì—ì„œ postId í™•ì¸ (ì•Œë¦¼ì—ì„œ í´ë¦­í•œ ê²½ìš°)
          const urlParams = new URLSearchParams(window.location.search);
          const postId = urlParams.get('postId');
          if (postId) {
            console.log("ì•Œë¦¼ì—ì„œ ê²Œì‹œë¬¼ í´ë¦­ë¨, postId:", postId);
            // ê²Œì‹œë¬¼ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
            window.location.href = `/posts/${postId}`;
          }
        } catch (error) {
          console.error(" window.onload ì¤‘ ì—ëŸ¬ ë°œìƒ:", error);
        }

        console.log("[window.onload] ì´ˆê¸°í™” ì™„ë£Œ");
      };

      // =====================================================
      //  UI í† ê¸€ ì´ë²¤íŠ¸ (ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ)
      // =====================================================
      const toggleChat = document.getElementById("toggle-chat");
      if (toggleChat) {
        toggleChat.addEventListener("click", function () {
          console.log(" [UI] ì±„íŒ…ì°½ í† ê¸€ í´ë¦­ë¨");
          toggleVisibility("chat-box");
        });
      }

      const toggleUser = document.getElementById("toggle-user");
      if (toggleUser) {
        toggleUser.addEventListener("click", function () {
          console.log(" [UI] ì‚¬ìš©ì ëª©ë¡ í† ê¸€ í´ë¦­ë¨");
          toggleVisibility("user-box");
        });
      }

      function toggleVisibility(id) {
        const element = document.getElementById(id);
        if (!element) {
          console.error(`[toggleVisibility] ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${id}`);
          return;
        }

        const prevDisplay = element.style.display;
        element.style.display =
          prevDisplay === "none" || prevDisplay === "" ? "flex" : "none";

        console.log(
          `[toggleVisibility] ${id}: ${prevDisplay} â†’ ${element.style.display}`
        );
      }

      // =====================================================
      // ğŸ”¹ ì„¸ì…˜ / ì‚¬ìš©ì ê´€ë ¨
      // =====================================================
      async function fetchMemberEmail() {
        console.log("[fetchMemberEmail] í˜¸ì¶œë¨");

        try {
          const response = await fetch("/api/members/session");
          console.log("[fetchMemberEmail] ì‘ë‹µ ìƒíƒœ ì½”ë“œ:", response.status);

          if (response.status === 401) {
            // ì„¸ì…˜ ë§Œë£Œ í˜¹ì€ ë¡œê·¸ì¸ í•„ìš”
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
            window.location.href = "/";
            return;
          }

          const data = await response.json();
          console.log("[fetchMemberEmail] ì‘ë‹µ ë°ì´í„°:", data);

          if (data.loginEmail) {
            console.log("ë¡œê·¸ì¸ ì´ë©”ì¼ í™•ì¸ë¨:", data.loginEmail);
            saveMemberEmail(data.loginEmail);
          } else {
            console.warn(
              "[fetchMemberEmail] ì‚¬ìš©ì ì´ë©”ì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤."
            );
            window.location.href = "/";
          }
        } catch (error) {
          console.error("[fetchMemberEmail] ì—ëŸ¬ ë°œìƒ:", error);
          window.location.href = "/"; // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œì—ë„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
        }
      }

      function saveMemberEmail(memberEmail) {
        console.log(
          "ğŸ’¾ [saveMemberEmail] sessionStorageì— ì €ì¥ ì‹œë„:",
          memberEmail
        );
        sessionStorage.setItem("loginEmail", memberEmail);
        currentUserEmail = memberEmail; // ì „ì—­ ë³€ìˆ˜ì—ë„ ì„¤ì •
        console.log("[saveMemberEmail] ì €ì¥ ì™„ë£Œ");
        
        // WebSocket ì—°ê²° (ì•„ì§ ì—°ê²°ë˜ì§€ ì•Šì€ ê²½ìš°)
        if (stompClient === null || !stompClient.connected) {
          connectWebSocket(memberEmail);
        }
      }
      /***
       * ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì´ë©”ì¼ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
       * /
       * */
      async function getMemberEmail() {
        try {
          // ì˜¬ë°”ë¥¸ URL (members)
          const response = await fetch("/api/members/session", {
            credentials: "include", // ì„¸ì…˜ ì¿ í‚¤ í¬í•¨
          });

          if (!response.ok) {
            throw new Error("ì„¸ì…˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }

          const data = await response.json();
          return data.loginEmail || null;
        } catch (error) {
          console.error("Error fetching session info:", error);
          return null;
        }
      }

      // =====================================================
      // ğŸ”¹ ê²Œì‹œë¬¼ ê´€ë ¨
      // =====================================================
      async function fetchPosts() {
        console.log("[fetchPosts] í•¨ìˆ˜ ì‹¤í–‰ë¨");

        try {
          console.log("/api/posts ë¡œ ìš”ì²­ ì‹œì‘");
          const response = await fetch("/api/posts");

          console.log("ì‘ë‹µ ìƒíƒœ ì½”ë“œ:", response.status);

          if (!response.ok) {
            console.error("ì‘ë‹µ ì‹¤íŒ¨:", response.statusText);
            return;
          }

          const responseData = await response.json();
          console.log("ì „ì²´ posts ë°ì´í„°:", responseData);

          // í˜ì´ì§• ì‘ë‹µì¸ ê²½ìš° content ë°°ì—´ ì¶”ì¶œ
          const posts = Array.isArray(responseData) ? responseData : (responseData.content || []);
          console.log("ì‹¤ì œ ê²Œì‹œë¬¼ ë°°ì—´:", posts);

          const memberEmail = await getMemberEmail();
          console.log("í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì ì´ë©”ì¼:", memberEmail);

          const postContainer = document.getElementById("postContainer");
          if (!postContainer) {
            console.error("postContainer ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
            return;
          }

          postContainer.innerHTML = "";
          console.log("postContainer ì´ˆê¸°í™” ì™„ë£Œ");

          if (!Array.isArray(posts)) {
            console.error("posts ë°ì´í„°ê°€ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤:", posts);
            return;
          }

          if (posts.length === 0) {
            console.log("ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.");
            postContainer.innerHTML = "<div style='padding: 20px; text-align: center; color: #536471;'>ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
            return;
          }

          posts.forEach((post, index) => {
            console.group(`ê²Œì‹œë¬¼ [${index}]`);
            console.log("post ë°ì´í„°:", post);

            const card = document.createElement("div");
            card.className = "card";
            card.setAttribute("data-id", post.id);
            card.onclick = function () {
              console.log(`ê²Œì‹œë¬¼ í´ë¦­ë¨ â†’ id: ${post.id}`);
              viewPost(post.id);
            };

            // ë³¸ì¸ ê¸€ì¼ ë•Œ ì‚­ì œ ë²„íŠ¼ (ì´ë©”ì¼ë¡œ ë¹„êµ)
            if (memberEmail && post.writerEmail === memberEmail) {
              console.log("ë³¸ì¸ ê²Œì‹œê¸€ â†’ ì‚­ì œ ë²„íŠ¼ ì¶”ê°€");
              const closeButton = document.createElement("span");
              closeButton.className = "close-button";
              closeButton.innerHTML = "&times;";
              closeButton.onclick = function (event) {
                console.log(`ê²Œì‹œë¬¼ ì‚­ì œ í´ë¦­ â†’ id: ${post.id}`);
                event.stopPropagation();
                deletePost(event, this.parentNode.getAttribute("data-id"));
              };
              card.appendChild(closeButton);
            } else {
              console.log("ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ê²Œì‹œê¸€ â†’ ì‚­ì œ ë²„íŠ¼ ì—†ìŒ");
            }

            // 1. í”„ë¡œí•„ ì´ë¯¸ì§€ (í—¤ì–´ ì´ë¯¸ì§€)
            const img = document.createElement("img");
            img.className = "profile-img";
            img.src = post.profilePicturePath;
            img.onerror = function () {
              console.warn(
                `í”„ë¡œí•„ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ (${post.profilePicturePath}), ê¸°ë³¸ ì´ë¯¸ì§€ë¡œ ëŒ€ì²´`
              );
              this.src = "/images/default-profile.png";
            };
            console.log(" í”„ë¡œí•„ ì´ë¯¸ì§€ ê²½ë¡œ:", img.src);

            // ì¹´ë“œ ì½˜í…ì¸  ì»¨í…Œì´ë„ˆ
            const cardContent = document.createElement("div");
            cardContent.className = "card-content";

            // 2. ì‚¬ìš©ì ì´ë¦„
            const header = document.createElement("div");
            header.className = "card-header";
            const authorLink = document.createElement("a");
            authorLink.href = `/member/profile/${encodeURIComponent(post.writerEmail)}`;
            authorLink.onclick = function(e) {
              e.stopPropagation();
            };
            authorLink.textContent = post.writerName || "(ì´ë¦„ ì—†ìŒ)";
            header.appendChild(authorLink);
            console.log("ì‘ì„±ì:", authorLink.textContent);

            // 3. ë‚ ì§œ
            const dateDiv = document.createElement("div");
            dateDiv.className = "card-date";
            const formattedDate = new Date(post.createdDate).toLocaleString("ko-KR", {
              year: 'numeric',
              month: 'short',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
            dateDiv.textContent = formattedDate;
            console.log("ì‘ì„±ì¼:", formattedDate);

            // 4. ë³¸ë¬¸
            const body = document.createElement("div");
            body.className = "card-body";
            body.textContent = post.content || "(ë‚´ìš© ì—†ìŒ)";
            console.log("ë‚´ìš©:", post.content);

            // 5. ë³¸ë¬¸ ì´ë¯¸ì§€
            if (post.imgsource) {
              console.log("ê²Œì‹œê¸€ ì´ë¯¸ì§€ ì¶”ê°€:", post.imgsource);
              const contentImg = document.createElement("img");
              contentImg.className = "content-img";
              contentImg.src = post.imgsource;
              contentImg.onerror = function () {
                console.warn(`ê²Œì‹œê¸€ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ (${post.imgsource})`);
                this.style.display = "none";
              };
              // ë³¸ë¬¸ ì´ë¯¸ì§€ëŠ” ë³¸ë¬¸ ë‹¤ìŒì— ì¶”ê°€
              body.appendChild(contentImg);
            } else {
              console.log("ê²Œì‹œê¸€ ì´ë¯¸ì§€ ì—†ìŒ");
            }

            // ìˆœì„œëŒ€ë¡œ ì¶”ê°€: í—¤ë”(ì‚¬ìš©ì ì´ë¦„) â†’ ë‚ ì§œ â†’ ë³¸ë¬¸(ë³¸ë¬¸ ì´ë¯¸ì§€ í¬í•¨)
            cardContent.appendChild(header);
            cardContent.appendChild(dateDiv);
            cardContent.appendChild(body);
            
            // ì¹´ë“œì— í”„ë¡œí•„ ì´ë¯¸ì§€ì™€ ì½˜í…ì¸  ì¶”ê°€
            card.appendChild(img);
            card.appendChild(cardContent);
            postContainer.appendChild(card);

            console.groupEnd();
          });

          console.log("ëª¨ë“  ê²Œì‹œë¬¼ ë Œë”ë§ ì™„ë£Œ");
        } catch (error) {
          console.error("ê²Œì‹œë¬¼ ê°€ì ¸ì˜¤ê¸° ì¤‘ ì—ëŸ¬ ë°œìƒ:", error);
        }
      }

      // =====================================================
      // ğŸ”¹ ê²Œì‹œë¬¼ ìƒì„¸ ë³´ê¸° (í˜ì´ì§€ ì´ë™)
      // =====================================================
      function viewPost(postId) {
        console.log("ğŸ” ê²Œì‹œë¬¼ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™:", postId);
        // URL ê¸°ë°˜ìœ¼ë¡œ ê²Œì‹œë¬¼ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
        window.location.href = `/posts/${postId}`;
      }
      // =====================================================
      // ğŸ”¹ ê²Œì‹œë¬¼ ì €ì¥
      // =====================================================

      async function savePost(event) {
        event.preventDefault(); // ê¸°ë³¸ form ì œì¶œ ë§‰ê¸°

        const content = document.getElementById("content").value;
        const fileInput = document.getElementById("fileUpload");
        const file = fileInput.files[0];

        // ì„¸ì…˜ì—ì„œ ë¡œê·¸ì¸ ì´ë©”ì¼ ê°€ì ¸ì˜¤ê¸°
        const userEmail = sessionStorage.getItem("loginEmail");

        if (!userEmail) {
          alert("ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
          return;
        }

        const formData = new FormData();
        formData.append("content", content);
        formData.append("email", userEmail); // ë°˜ë“œì‹œ userEmail ì‚¬ìš©
        if (file) {
          formData.append("file", file);
        }

        try {
          const response = await fetch("/api/posts/upload", {
            method: "POST",
            body: formData,
            credentials: "include",
          });

          if (!response.ok) {
            throw new Error("ê²Œì‹œë¬¼ì„ ì €ì¥í•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }

          const message = await response.text();
          alert(message);
          fetchPosts();
        } catch (error) {
          console.error("Error:", error);
        }
      }

      // =====================================================
      // ğŸ”¹ ê²Œì‹œë¬¼ ì‚­ì œ
      // =====================================================

      async function deletePost(event, postId) {
        event.stopPropagation();
        if (confirm("ê²Œì‹œë¬¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          try {
            const response = await fetch(`/api/posts/${postId}`, {
              method: "DELETE",
            });

            if (!response.ok) {
              throw new Error("ê²Œì‹œë¬¼ ì‚­ì œ ì‹¤íŒ¨");
            }
            alert("ê²Œì‹œë¬¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            fetchPosts();
          } catch (error) {
            console.error("Error:", error);
          }
        }
      }

      // =====================================================
      // ğŸ”¹ ëŒ“ê¸€ FETCH
      // =====================================================
      async function fetchComments(postId) {
        try {
          const response = await fetch(`/api/posts/${postId}/comments`);
          const comments = await response.json();

          const commentsContainer = document.getElementById("comments");
          commentsContainer.innerHTML = "";

          comments.forEach((comment) => {
            const commentDiv = document.createElement("div");
            commentDiv.className = "comment";

            // ì‘ì„±ì í”„ë¡œí•„ ì´ë¯¸ì§€ ì‚¬ìš©
            const img = document.createElement("img");
            img.className = "profile-img";
            img.src = comment.writerProfile; // DTOì—ì„œ ê°€ì ¸ì˜¨ í”„ë¡œí•„ ê²½ë¡œ
            img.onerror = function() {
              this.src = "/images/default-profile.png";
            };

            const commentContent = document.createElement("div");
            commentContent.style.flex = "1";
            commentContent.innerHTML = `
                <p style="margin: 0 0 4px 0;"><strong>${comment.writerName}</strong></p>
                <p style="margin: 0; color: #0f1419;">${comment.comment}</p>
            `;

            commentDiv.appendChild(img);
            commentDiv.appendChild(commentContent);
            commentsContainer.appendChild(commentDiv);
          });
        } catch (error) {
          console.error("Error fetching comments:", error);
        }
      }
      // =====================================================
      // ëŒ“ê¸€ ì‘ì„±
      // =====================================================
      //  ëŒ“ê¸€ ì‘ì„± í•¨ìˆ˜ (postId ì¸ìë¡œ ë°›ê¸°)
      async function submitComment(postId) {
        const commentContent = document.getElementById("commentContent").value;
        
        if (!commentContent || commentContent.trim() === "") {
          alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        const userEmail = await getMemberEmail();
        if (!userEmail) {
          alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
          return;
        }

        const data = {
          comment: commentContent,
          user: userEmail,
        };

        try {
          console.log(" ëŒ“ê¸€ ì‘ì„± ìš”ì²­ postId:", postId, "user:", userEmail);

          const response = await fetch(`/api/posts/${postId}/comments`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          if (!response.ok) {
            const errorText = await response.text();
            console.error("ëŒ“ê¸€ ì €ì¥ ì‹¤íŒ¨:", errorText);
            throw new Error("ëŒ“ê¸€ ì €ì¥ ì‹¤íŒ¨: " + errorText);
          }

          alert("ëŒ“ê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
          document.getElementById("commentContent").value = ""; // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
          fetchComments(postId);
        } catch (error) {
          console.error(" Error submitting comment:", error);
          alert("ëŒ“ê¸€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
        }
      }

      function getPostIdFromUrl() {
        const pathParts = window.location.pathname.split("/");
        return pathParts[pathParts.length - 1];
      }

      // =====================================================
      // ğŸ”¹ ì¢‹ì•„ìš” / ëª¨ë‹¬ ê´€ë ¨
      // =====================================================
      async function toggleLove(postId, button) {
        const user = await getMemberEmail();
        if (!user || user === "defaultEmail") {
          alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
          return;
        }

        console.log(`[toggleLove] í˜¸ì¶œë¨ â†’ postId=${postId}, user=${user}`);

        try {
          const response = await fetch(
            `/api/posts/${postId}/likes?email=${encodeURIComponent(user)}`,
            { method: "POST" }
          );

          console.log("[toggleLove] ì‘ë‹µ ìƒíƒœ:", response.status);

          if (!response.ok) {
            const errorText = await response.text();
            console.error("ì¢‹ì•„ìš” ì‹¤íŒ¨:", errorText);
            throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${errorText}`);
          }

          const data = await response.json();
          console.log("[toggleLove] ì„œë²„ ì‘ë‹µ:", data);

          let currentCount = parseInt(
            button.textContent.match(/\d+/)?.[0] || "0"
          );

          if (data.liked) {
            button.textContent = `${currentCount + 1}`;
            button.style.color = "#f4212e";
          } else {
            button.textContent = `${currentCount - 1}`;
            button.style.color = "#536471";
          }
        } catch (error) {
          console.error(" [toggleLove] ì—ëŸ¬:", error);
          alert("ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
        }
      }

      function closeModal() {
        const modal = document.getElementById("postModal");
        modal.style.display = "none";
      }

      // =====================================================
      // ğŸ”¹ ì•Œë¦¼ ê´€ë ¨ (í˜ì´ì§€ë¡œ ì´ë™)
      // =====================================================
      function showNotificationModal() {
        // ì•Œë¦¼ í˜ì´ì§€ë¡œ ì´ë™
        window.location.href = '/posts/notifications/page';
      }
      
      // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
      window.addEventListener('click', function(event) {
        const postModal = document.getElementById("postModal");
        const notificationModal = document.getElementById("notificationModal");
        
        // postModal ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸° (ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ)
        if (postModal && event.target === postModal) {
          closeModal();
        }
        
        // notificationModal ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸° (ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ)
        if (notificationModal && event.target === notificationModal) {
          closeNotificationModal();
        }
      });
      
      // ëª¨ë‹¬ ì½˜í…ì¸  í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€ (ì´ˆê¸° ë¡œë“œ ì‹œ)
      document.addEventListener('DOMContentLoaded', function() {
        const postModalContent = document.querySelector("#postModal .modal-content");
        const notificationModalContent = document.querySelector("#notificationModal .modal-content");
        
        if (postModalContent) {
          postModalContent.addEventListener('click', function(e) {
            e.stopPropagation();
          });
        }
        
        if (notificationModalContent) {
          notificationModalContent.addEventListener('click', function(e) {
            e.stopPropagation();
          });
        }
      });

      // =====================================================
      // ğŸ”¹ ì±„íŒ… ì…ë ¥ ì´ë²¤íŠ¸ (ë§ˆì§€ë§‰ì— ë°°ì¹˜, ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ)
      // =====================================================
      const chatInput = document.getElementById("chat-input");
      if (chatInput) {
        chatInput.addEventListener("keydown", function (event) {
          if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault();
            const sendBtn = document.getElementById("send-btn");
            if (sendBtn) {
              sendBtn.click();
            }
          }
        });
      }
    </script>
  </body>
</html>
