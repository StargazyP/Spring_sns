<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì•Œë¦¼</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background-color: #ffffff;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        color: #0f1419;
        line-height: 1.5;
        min-height: 100vh;
        padding: 0;
        margin: 0;
      }

      .wrapper {
        max-width: 600px;
        margin: 0 auto;
        background-color: #ffffff;
        min-height: 100vh;
        border-left: 1px solid #eff3f4;
        border-right: 1px solid #eff3f4;
      }

      /* X ìŠ¤íƒ€ì¼ ë„¤ë¹„ê²Œì´ì…˜ ë°” */
      .navbar {
        position: sticky;
        top: 0;
        background-color: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(12px);
        border-bottom: 1px solid #eff3f4;
        padding: 16px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 100;
        min-height: 64px;
      }

      .navbar-left {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .back-button {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.2s;
        border: none;
        background: transparent;
        font-size: 20px;
        color: #0f1419;
      }

      .back-button:hover {
        background-color: #f7f9f9;
      }

      .navbar-title {
        font-size: 20px;
        font-weight: 700;
        color: #0f1419;
      }

      .navbar img {
        cursor: pointer;
        padding: 10px;
        border-radius: 50%;
        transition: background-color 0.2s;
        object-fit: contain;
      }

      .navbar img:hover {
        background-color: #f7f9f9;
      }

      .navbar img[src="/images/home.png"] {
        width: 52px;
        height: 52px;
      }

      .navbar img[src="/images/user.png"] {
        width: 61px;
        height: 52px;
      }

      .navbar img[src="/Message.png"] {
        width: 52px;
        height: 52px;
      }

      .navbar img[src="/images/alram.png"] {
        width: 61px;
        height: 52px;
        position: relative;
      }
      
      /* 12-23 ì•Œë¦¼ ë°°ì§€ ìŠ¤íƒ€ì¼ (ì‹¤ì‹œê°„ ì•Œë¦¼ ìˆ˜ í‘œì‹œ) */
      .notification-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        background-color: #ef4444;
        color: white;
        border-radius: 50%;
        min-width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        padding: 0 6px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        z-index: 101;
        opacity: 0;
        transform: scale(0);
        transition: opacity 0.3s, transform 0.3s;
      }
      
      .notification-badge.show {
        opacity: 1;
        transform: scale(1);
      }
      
      /* 12-23 ì•Œë¦¼ ì•„ì´ì½˜ ì»¨í…Œì´ë„ˆ */
      .notification-icon-container {
        position: relative;
        display: inline-block;
      }
      
      .notification-icon-container img {
        cursor: pointer;
      }

      .navbar img[src="/images/logout.png"] {
        width: 52px;
        height: 52px;
      }

      /* ì•Œë¦¼ ì»¨í…Œì´ë„ˆ */
      .notifications-container {
        padding: 0;
      }

      .notification-item {
        padding: 16px;
        border-bottom: 1px solid #eff3f4;
        cursor: pointer;
        transition: background-color 0.2s;
        display: block;
        text-decoration: none;
        color: inherit;
      }

      .notification-item:hover {
        background-color: #f7f9f9;
      }

      .notification-item.unread {
        background-color: #f7f9f9;
      }

      .notification-item.read {
        background-color: #ffffff;
      }

      .notification-type {
        font-weight: 700;
        color: #0f1419;
        margin-bottom: 4px;
        font-size: 15px;
      }

      .notification-action {
        margin: 4px 0;
        color: #0f1419;
        font-size: 15px;
      }

      .notification-content {
        font-size: 15px;
        color: #536471;
        margin-top: 8px;
        padding: 8px;
        background-color: #f7f9f9;
        border-radius: 8px;
        word-wrap: break-word;
      }

      .notification-date {
        font-size: 13px;
        color: #536471;
        margin-top: 8px;
      }

      .empty-message {
        text-align: center;
        padding: 60px 20px;
        color: #536471;
        font-size: 15px;
      }

      .loading {
        text-align: center;
        padding: 60px 20px;
        color: #536471;
        font-size: 15px;
      }

      .error {
        text-align: center;
        padding: 60px 20px;
        color: #f4212e;
        font-size: 15px;
      }

      /* ë°˜ì‘í˜• ë””ìì¸ */
      @media (max-width: 768px) {
        .wrapper {
          max-width: 100%;
          border-left: none;
          border-right: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <!-- Navigation Bar -->
      <div class="navbar">
        <div class="navbar-left">
          <button class="back-button" onclick="goBack()">â†</button>
          <div class="navbar-title">ì•Œë¦¼</div>
        </div>
        <div style="display: flex; gap: 20px;">
          <img
            src="/images/home.png"
            alt="home"
            onclick="location.href='/main';"
          />
          <img
            src="/images/user.png"
            alt="User"
            onclick="location.href='/member/mypage';"
          />
          <img
            src="/Message.png"
            alt="Message"
            onclick="location.href='/chat/message';"
          />
          <!-- 12-23 ì•ŒëŒ ì•„ì´ì½˜ (ì‹¤ì‹œê°„ ì•Œë¦¼ ìˆ˜ ë°°ì§€ í¬í•¨) -->
          <div class="notification-icon-container">
            <img
              src="/images/alram.png"
              alt="Alarm"
              onclick="location.href='/posts/notifications/page';"
              id="notificationIcon"
            />
            <span id="notificationBadge" class="notification-badge">0</span>
          </div>
          <img
            src="/images/logout.png"
            alt="Logout"
            onclick="document.getElementById('logout').submit();"
          />
          <form id="logout" action="/api/members/logout" method="post"></form>
        </div>
      </div>

      <!-- ì•Œë¦¼ ëª©ë¡ -->
      <div id="notificationsContainer" class="notifications-container">
        <div class="loading">ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script type="text/javascript">
      // =====================================================
      // 12-23 WebSocket ì—°ê²° ë° ì•Œë¦¼ ìˆ˜ ìˆ˜ì‹  (ì‹¤ì‹œê°„ ì•Œë¦¼ ê¸°ëŠ¥)
      // =====================================================
      let stompClient = null;
      let currentUserEmail = null;
      
      function connectWebSocket(email) {
        if (!email) {
          console.warn("ì´ë©”ì¼ì´ ì—†ì–´ WebSocket ì—°ê²°ì„ ê±´ë„ˆëœë‹ˆë‹¤.");
          return;
        }
        
        currentUserEmail = email;
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        
        stompClient.connect({}, function(frame) {
          console.log('WebSocket ì—°ê²°ë¨: ' + frame);
          
          // ì´ë©”ì¼ì„ URL-safeí•˜ê²Œ ë³€í™˜
          const emailPath = email.replace('@', '_').replace(/\./g, '_');
          
          // 12-23 ì•Œë¦¼ ìˆ˜ êµ¬ë…
          stompClient.subscribe('/topic/notifications/count/' + emailPath, function(message) {
            const count = parseInt(JSON.parse(message.body));
            console.log('ì•Œë¦¼ ìˆ˜ ì—…ë°ì´íŠ¸:', count);
            updateNotificationBadge(count);
          });
          
          // 12-23 ì´ˆê¸° ì•Œë¦¼ ìˆ˜ ì¡°íšŒ
          fetchNotificationCount();
        }, function(error) {
          console.error('WebSocket ì—°ê²° ì˜¤ë¥˜:', error);
        });
      }
      
      function disconnectWebSocket() {
        if (stompClient !== null) {
          stompClient.disconnect();
          console.log('WebSocket ì—°ê²° ì¢…ë£Œ');
        }
      }
      
      // í˜ì´ì§€ë¥¼ ë– ë‚  ë•Œ WebSocket ì—°ê²° ì¢…ë£Œ
      window.addEventListener('beforeunload', function() {
        disconnectWebSocket();
      });
      
      // í˜„ì¬ ì‚¬ìš©ì ì´ë©”ì¼ ê°€ì ¸ì˜¤ê¸°
      async function getCurrentUserEmail() {
        try {
          const response = await fetch("/api/members/session", {
            credentials: "include"
          });
          if (response.ok) {
            const data = await response.json();
            return data.loginEmail;
          }
        } catch (error) {
          console.error("ì‚¬ìš©ì ì´ë©”ì¼ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error);
        }
        return null;
      }
      
      // 12-23 ì•Œë¦¼ ë°°ì§€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
      function updateNotificationBadge(count) {
        const badge = document.getElementById('notificationBadge');
        if (badge) {
          if (count > 0) {
            badge.textContent = count > 99 ? '99+' : count.toString();
            badge.classList.add('show');
          } else {
            badge.classList.remove('show');
          }
        }
      }
      
      // 12-23 ì•Œë¦¼ ìˆ˜ ì¡°íšŒ í•¨ìˆ˜
      async function fetchNotificationCount() {
        try {
          const response = await fetch('/posts/notifications', {
            credentials: 'include'
          });
          if (response.ok) {
            const notifications = await response.json();
            updateNotificationBadge(notifications.length);
          }
        } catch (error) {
          console.error('ì•Œë¦¼ ìˆ˜ ì¡°íšŒ ì‹¤íŒ¨:', error);
        }
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì•Œë¦¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      window.onload = async function () {
        const email = await getCurrentUserEmail();
        if (email) {
          connectWebSocket(email);
        }
        await loadNotifications();
      };

      // ë’¤ë¡œ ê°€ê¸°
      function goBack() {
        window.history.back();
      }

      // 12-23 ì•Œë¦¼ ë¡œë“œ í•¨ìˆ˜
      async function loadNotifications() {
        const container = document.getElementById("notificationsContainer");
        
        try {
          const response = await fetch("/posts/notifications/all", {
            credentials: "include"
          });
          
          if (!response.ok) {
            if (response.status === 401) {
              container.innerHTML = "<div class='error'>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>";
              setTimeout(() => {
                window.location.href = "/";
              }, 2000);
              return;
            }
            throw new Error("ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          }

          const notifications = await response.json();
          renderNotifications(notifications);
          
          // 12-23 ì½ì§€ ì•Šì€ ì•Œë¦¼ ìˆ˜ ì—…ë°ì´íŠ¸
          const unreadCount = notifications.filter(n => !n.isRead).length;
          updateNotificationBadge(unreadCount);
        } catch (error) {
          console.error("ì•Œë¦¼ ë¡œë“œ ì˜¤ë¥˜:", error);
          container.innerHTML = "<div class='error'>ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>";
        }
      }

      // 12-23 ì•Œë¦¼ ë Œë”ë§ í•¨ìˆ˜
      function renderNotifications(notifications) {
        const container = document.getElementById("notificationsContainer");
        
        if (!notifications || notifications.length === 0) {
          container.innerHTML = "<div class='empty-message'>ìƒˆë¡œìš´ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
          return;
        }

        container.innerHTML = "";
        notifications.forEach(notification => {
          const item = document.createElement("div");
          item.className = `notification-item ${notification.isRead ? 'read' : 'unread'}`;
          
          const typeText = notification.notificationType === "LIKE" ? "â¤ï¸ ì¢‹ì•„ìš”" : "ğŸ’¬ ëŒ“ê¸€";
          const actionText = notification.notificationType === "LIKE" ? "ì¢‹ì•„ìš”ë¥¼ ëˆŒë €ìŠµë‹ˆë‹¤" : "ëŒ“ê¸€ì„ ë‚¨ê²¼ìŠµë‹ˆë‹¤";
          const actorName = notification.actorName || notification.actorEmail;
          const date = new Date(notification.createdAt).toLocaleString("ko-KR", {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
          
          item.innerHTML = `
            <div class="notification-type">${typeText}</div>
            <div class="notification-action">${actorName}ë‹˜ì´ ${actionText}</div>
            ${notification.postContent ? `<div class="notification-content">${notification.postContent.substring(0, 100)}${notification.postContent.length > 100 ? '...' : ''}</div>` : ""}
            <div class="notification-date">${date}</div>
          `;
          
          // 12-23 ì•Œë¦¼ í´ë¦­ ì‹œ ì½ìŒ ì²˜ë¦¬ ë° ê²Œì‹œë¬¼ í˜ì´ì§€ë¡œ ì´ë™
          item.onclick = async function(event) {
            event.preventDefault();
            
            // ì´ë¯¸ ì½ì€ ì•Œë¦¼ì´ë©´ ë°”ë¡œ ì´ë™
            if (notification.isRead) {
              window.location.href = `/posts/${notification.postId}`;
              return;
            }
            
            // 12-23 ì½ì§€ ì•Šì€ ì•Œë¦¼ë§Œ ì½ìŒ ì²˜ë¦¬
            try {
              const response = await fetch(`/posts/notifications/read?notificationId=${notification.id}`, {
                method: 'POST',
                credentials: 'include'
              });
              
              if (response.ok) {
                console.log('ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ì™„ë£Œ:', notification.id);
                // 12-23 ì½ìŒ ì²˜ë¦¬ëœ ì•Œë¦¼ì˜ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
                item.className = 'notification-item read';
                // ì•Œë¦¼ ëª©ë¡ì—ì„œ í•´ë‹¹ ì•Œë¦¼ì˜ isRead ìƒíƒœ ì—…ë°ì´íŠ¸
                notification.isRead = true;
              } else {
                console.error('ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨:', response.status);
              }
            } catch (error) {
              console.error('ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
            }
            
            // ê²Œì‹œë¬¼ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
            window.location.href = `/posts/${notification.postId}`;
          };
          
          container.appendChild(item);
        });
      }
    </script>
  </body>
</html>

