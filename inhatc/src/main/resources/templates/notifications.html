<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì•Œë¦¼</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background-color: #ffffff;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        color: #0f1419;
        line-height: 1.5;
        min-height: 100vh;
        padding: 0;
        margin: 0;
      }

      .wrapper {
        max-width: 600px;
        margin: 0 auto;
        background-color: #ffffff;
        min-height: 100vh;
        border-left: 1px solid #eff3f4;
        border-right: 1px solid #eff3f4;
      }

      /* X ìŠ¤íƒ€ì¼ ë„¤ë¹„ê²Œì´ì…˜ ë°” */
      .navbar {
        position: sticky;
        top: 0;
        background-color: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(12px);
        border-bottom: 1px solid #eff3f4;
        padding: 16px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 100;
        min-height: 64px;
      }

      .navbar-left {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .back-button {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.2s;
        border: none;
        background: transparent;
        font-size: 20px;
        color: #0f1419;
      }

      .back-button:hover {
        background-color: #f7f9f9;
      }

      .navbar-title {
        font-size: 20px;
        font-weight: 700;
        color: #0f1419;
      }

      .navbar img {
        cursor: pointer;
        padding: 10px;
        border-radius: 50%;
        transition: background-color 0.2s;
        object-fit: contain;
      }

      .navbar img:hover {
        background-color: #f7f9f9;
      }

      .navbar img[src="/images/home.png"] {
        width: 52px;
        height: 52px;
      }

      .navbar img[src="/images/user.png"] {
        width: 61px;
        height: 52px;
      }

      .navbar img[src="/Message.png"] {
        width: 52px;
        height: 52px;
      }

      .navbar img[src="/images/alram.png"] {
        width: 61px;
        height: 52px;
      }

      .navbar img[src="/images/logout.png"] {
        width: 52px;
        height: 52px;
      }

      /* ì•Œë¦¼ ì»¨í…Œì´ë„ˆ */
      .notifications-container {
        padding: 0;
      }

      .notification-item {
        padding: 16px;
        border-bottom: 1px solid #eff3f4;
        cursor: pointer;
        transition: background-color 0.2s;
        display: block;
        text-decoration: none;
        color: inherit;
      }

      .notification-item:hover {
        background-color: #f7f9f9;
      }

      .notification-item.unread {
        background-color: #f7f9f9;
      }

      .notification-item.read {
        background-color: #ffffff;
      }

      .notification-type {
        font-weight: 700;
        color: #0f1419;
        margin-bottom: 4px;
        font-size: 15px;
      }

      .notification-action {
        margin: 4px 0;
        color: #0f1419;
        font-size: 15px;
      }

      .notification-content {
        font-size: 15px;
        color: #536471;
        margin-top: 8px;
        padding: 8px;
        background-color: #f7f9f9;
        border-radius: 8px;
        word-wrap: break-word;
      }

      .notification-date {
        font-size: 13px;
        color: #536471;
        margin-top: 8px;
      }

      .empty-message {
        text-align: center;
        padding: 60px 20px;
        color: #536471;
        font-size: 15px;
      }

      .loading {
        text-align: center;
        padding: 60px 20px;
        color: #536471;
        font-size: 15px;
      }

      .error {
        text-align: center;
        padding: 60px 20px;
        color: #f4212e;
        font-size: 15px;
      }

      /* ë°˜ì‘í˜• ë””ìì¸ */
      @media (max-width: 768px) {
        .wrapper {
          max-width: 100%;
          border-left: none;
          border-right: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <!-- Navigation Bar -->
      <div class="navbar">
        <div class="navbar-left">
          <button class="back-button" onclick="goBack()">â†</button>
          <div class="navbar-title">ì•Œë¦¼</div>
        </div>
        <div style="display: flex; gap: 20px;">
          <img
            src="/images/home.png"
            alt="home"
            onclick="location.href='/main';"
          />
          <img
            src="/images/user.png"
            alt="User"
            onclick="location.href='/member/mypage';"
          />
          <img
            src="/Message.png"
            alt="Message"
            onclick="location.href='/chat/message';"
          />
          <img
            src="/images/alram.png"
            alt="Alarm"
            onclick="location.href='/posts/notifications/page';"
          />
          <img
            src="/images/logout.png"
            alt="Logout"
            onclick="document.getElementById('logout').submit();"
          />
          <form id="logout" action="/api/members/logout" method="post"></form>
        </div>
      </div>

      <!-- ì•Œë¦¼ ëª©ë¡ -->
      <div id="notificationsContainer" class="notifications-container">
        <div class="loading">ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    </div>

    <script type="text/javascript">
      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì•Œë¦¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      window.onload = async function () {
        await loadNotifications();
      };

      // ë’¤ë¡œ ê°€ê¸°
      function goBack() {
        window.history.back();
      }

      // ì•Œë¦¼ ë¡œë“œ
      async function loadNotifications() {
        const container = document.getElementById("notificationsContainer");
        
        try {
          const response = await fetch("/posts/notifications/all", {
            credentials: "include"
          });
          
          if (!response.ok) {
            if (response.status === 401) {
              container.innerHTML = "<div class='error'>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>";
              setTimeout(() => {
                window.location.href = "/";
              }, 2000);
              return;
            }
            throw new Error("ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          }

          const notifications = await response.json();
          renderNotifications(notifications);
        } catch (error) {
          console.error("ì•Œë¦¼ ë¡œë“œ ì˜¤ë¥˜:", error);
          container.innerHTML = "<div class='error'>ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>";
        }
      }

      // ì•Œë¦¼ ë Œë”ë§
      function renderNotifications(notifications) {
        const container = document.getElementById("notificationsContainer");
        
        if (!notifications || notifications.length === 0) {
          container.innerHTML = "<div class='empty-message'>ìƒˆë¡œìš´ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
          return;
        }

        container.innerHTML = "";
        notifications.forEach(notification => {
          const item = document.createElement("div");
          item.className = `notification-item ${notification.isRead ? 'read' : 'unread'}`;
          
          const typeText = notification.notificationType === "LIKE" ? "â¤ï¸ ì¢‹ì•„ìš”" : "ğŸ’¬ ëŒ“ê¸€";
          const actionText = notification.notificationType === "LIKE" ? "ì¢‹ì•„ìš”ë¥¼ ëˆŒë €ìŠµë‹ˆë‹¤" : "ëŒ“ê¸€ì„ ë‚¨ê²¼ìŠµë‹ˆë‹¤";
          const actorName = notification.actorName || notification.actorEmail;
          const date = new Date(notification.createdAt).toLocaleString("ko-KR", {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
          
          item.innerHTML = `
            <div class="notification-type">${typeText}</div>
            <div class="notification-action">${actorName}ë‹˜ì´ ${actionText}</div>
            ${notification.postContent ? `<div class="notification-content">${notification.postContent.substring(0, 100)}${notification.postContent.length > 100 ? '...' : ''}</div>` : ""}
            <div class="notification-date">${date}</div>
          `;
          
          item.onclick = function() {
            // ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬
            fetch(`/posts/notifications/read?notificationId=${notification.id}`, {
              method: 'POST'
            });
            // ê²Œì‹œë¬¼ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
            window.location.href = `/posts/${notification.postId}`;
          };
          
          container.appendChild(item);
        });
      }
    </script>
  </body>
</html>

