# 댓글/대댓글 구조 및 렌더링 흐름

## 1. 데이터 구조 (트리 구조)

```
댓글 트리 구조:
┌─────────────────────────────────────────┐
│         comments container              │
│  (원래 큰 container, 새로운 container  │
│   생성하지 않음)                        │
└─────────────────────────────────────────┘
         │
         ├─ 댓글 1 (depth: 0, parentId: null)
         │   │
         │   ├─ 대댓글 1-1 (depth: 1, parentId: 댓글1)
         │   │   │
         │   │   └─ 대댓글 1-1-1 (depth: 2, parentId: 대댓글1-1)
         │   │
         │   └─ 대댓글 1-2 (depth: 1, parentId: 댓글1)
         │
         ├─ 댓글 2 (depth: 0, parentId: null)
         │   │
         │   └─ 대댓글 2-1 (depth: 1, parentId: 댓글2)
         │
         └─ 댓글 3 (depth: 0, parentId: null)
```

## 2. 렌더링 흐름

### 2.1 댓글 로드 과정

```
1. API 호출
   └─> /api/posts/{postId}/comments?all=true
       └─> 모든 댓글과 대댓글을 배열로 받음

2. 트리 구조 변환
   └─> buildCommentTree(comments)
       ├─> CommentNode 객체 생성
       ├─> 부모-자식 관계 설정
       └─> 루트 노드들 반환 (depth === 0)

3. 루트 댓글 필터링
   └─> commentTree.filter(node => node.depth === 0)
       └─> 루트 댓글만 추출

4. 페이징 처리
   └─> rootComments.slice(startIndex, endIndex)
       └─> 현재 페이지에 해당하는 루트 댓글만 선택

5. 렌더링 (재귀적)
   └─> renderCommentNodeWithChildren(container, node)
       ├─> renderCommentNodeFlat(container, node)  // 현재 댓글 렌더링
       └─> node.children.forEach(child => 
             renderCommentNodeWithChildren(container, child))  // 자식 대댓글 재귀 렌더링
```

### 2.2 실제 DOM 구조

```
<div id="comments">  ← 원래 큰 container (새로운 container 생성 안 함)
    │
    ├─ <div class="comment" data-comment-id="1" data-depth="0">  ← 댓글 1
    │   ├─ <img class="profile-img" />
    │   └─ <div class="comment-content">
    │       ├─ 작성자, 시간
    │       ├─ 댓글 내용
    │       ├─ 답글 버튼
    │       └─ 답글 작성 폼
    │
    ├─ <div class="comment comment-reply" data-comment-id="2" data-depth="1" data-parent-id="1">  ← 대댓글 1-1
    │   ├─ <img class="profile-img" />
    │   └─ <div class="comment-content">
    │       ├─ 작성자, 시간
    │       ├─ 대댓글 내용
    │       ├─ 답글 버튼
    │       └─ 답글 작성 폼
    │
    ├─ <div class="comment comment-reply" data-comment-id="3" data-depth="2" data-parent-id="2">  ← 대댓글 1-1-1
    │   ├─ <img class="profile-img" />
    │   └─ <div class="comment-content">
    │       └─ ...
    │
    ├─ <div class="comment comment-reply" data-comment-id="4" data-depth="1" data-parent-id="1">  ← 대댓글 1-2
    │   └─ ...
    │
    ├─ <div class="comment" data-comment-id="5" data-depth="0">  ← 댓글 2
    │   └─ ...
    │
    └─ <div class="comment comment-reply" data-comment-id="6" data-depth="1" data-parent-id="5">  ← 대댓글 2-1
        └─ ...
</div>
```

## 3. 들여쓰기 처리

```
댓글 (depth: 0)
  margin-left: 0px
  └─ 대댓글 (depth: 1)
      margin-left: 56px
      └─ 대댓글 (depth: 2)
          margin-left: 112px
          └─ 대댓글 (depth: 3)
              margin-left: 168px
```

**계산식**: `margin-left = 56px * depth`

## 4. 숨김/표시 처리

### 4.1 기본 상태
- 댓글 (depth: 0): 항상 표시
- 대댓글 (depth > 0): 기본적으로 숨김 (`reply-hidden` 클래스)

### 4.2 "답글 보기" 버튼 클릭 시
```
1. 부모 댓글에 "expanded" 클래스 추가
2. 모든 하위 대댓글의 "reply-hidden" 클래스 제거
3. 버튼 텍스트 변경: "답글 N개 보기" → "답글 숨기기"
```

### 4.3 CSS 클래스 동작
```css
.comment-reply.reply-hidden {
  display: none;  /* 숨김 */
}

.comment.expanded ~ .comment-reply[data-parent-id="..."] {
  display: flex;  /* 표시 */
}
```

## 5. 무한 스크롤 처리

```
페이지 1 (처음 로드)
├─ 루트 댓글 1 (자식 대댓글 포함)
├─ 루트 댓글 2 (자식 대댓글 포함)
├─ 루트 댓글 3 (자식 대댓글 포함)
└─ ... (최대 20개 루트 댓글)

페이지 2 (스크롤 시)
├─ 루트 댓글 21 (자식 대댓글 포함)
├─ 루트 댓글 22 (자식 대댓글 포함)
└─ ... (다음 20개 루트 댓글)
```

## 6. 핵심 함수 흐름

```
loadComments()
  │
  ├─> buildCommentTree()  // 트리 구조 변환
  │
  ├─> commentTree.filter(node => node.depth === 0)  // 루트 댓글만
  │
  ├─> rootComments.slice(startIndex, endIndex)  // 페이징
  │
  └─> commentsToRender.forEach(node => 
        renderCommentNodeWithChildren(container, node))
          │
          ├─> renderCommentNodeFlat(container, node)  // 현재 댓글 렌더링
          │   └─> container.appendChild(commentDiv)  // 같은 container에 추가
          │
          └─> node.children.forEach(child => 
                renderCommentNodeWithChildren(container, child))  // 재귀
                └─> (자식 대댓글도 같은 container에 추가)
```

## 7. 주요 특징

### ✅ 장점
1. **단일 Container**: 새로운 container를 만들지 않고 원래 큰 container에 모든 댓글/대댓글 추가
2. **재귀적 렌더링**: 댓글과 대댓글이 자연스럽게 연결되어 표시
3. **들여쓰기**: depth에 따라 자동으로 들여쓰기 처리
4. **효율적**: 트리 구조를 유지하면서도 DOM에는 평면적으로 추가

### 📝 데이터 속성
- `data-comment-id`: 댓글 ID
- `data-depth`: 댓글 깊이 (0 = 댓글, 1+ = 대댓글)
- `data-parent-id`: 부모 댓글 ID (대댓글인 경우)

### 🎨 CSS 클래스
- `comment`: 기본 댓글
- `comment-reply`: 대댓글
- `reply-hidden`: 숨김 처리된 대댓글
- `expanded`: 대댓글이 표시된 부모 댓글

